/*!---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *----------------------------------------------------------*/
"use strict";
var Q = require("q");
var AccountManager = (function () {
    function AccountManager(providers, store) {
        var _this = this;
        /* tslint:disable no-require-imports */
        this.store = store || new (require("./store/inMemory").default)();
        /* tslint:enable */
        this.providers = providers;
        this.providers.forEach(function (provider) { return provider.on("stale", function (account) { return _this.store.updateState(account.key, true); }); });
    }
    AccountManager.prototype.queryProviders = function (query) {
        query = query || {};
        return Q.resolve(this.providers.filter(function (provider) {
            // Filter on the provider ID if supplied
            if (query.id && provider.id !== query.id) {
                return false;
            }
            // Filter on the provider arguments if supplied
            if (query.args) {
                if (!provider.args) {
                    return false;
                }
                for (var key in query.args) {
                    if (provider.args[key] !== query.args[key]) {
                        return false;
                    }
                }
            }
            // Filter on the provider settings if supplied
            if (query.settings) {
                if (!provider.settings) {
                    return false;
                }
                for (var key in query.settings) {
                    if (!provider.settings[key]) {
                        return false;
                    }
                    // some settings are resources which have ids and endpoints, check if that is the case first
                    if (!!query.settings[key].id || !!query.settings[key].endpoint) {
                        // setting is a resource
                        if (!!query.settings[key].id && provider.settings[key].id !== query.settings[key].id) {
                            // setting had an id, and the id of the same setting on the provider didn't match
                            return false;
                        }
                        if (!!query.settings[key].endpoint && provider.settings[key].endpoint !== query.settings[key].endpoint) {
                            // setting had an endpoint, and the endpoint of the same setting on the provider didn't match
                            return false;
                        }
                    }
                    else if (provider.settings[key] !== query.settings[key]) {
                        return false;
                    }
                }
            }
            return true;
        }));
    };
    AccountManager.prototype.getProvider = function (id, args, settings) {
        return this.queryProviders({ id: id, args: args, settings: settings }).then(function (providers) {
            if (providers.length !== 1) {
                return Q.reject(new Error("Unmatched or ambiguous account provider."));
            }
            return providers[0];
        });
    };
    AccountManager.prototype.add = function (providerId, providerArgs, providerSettings) {
        var _this = this;
        return this.getProvider(providerId, providerArgs, providerSettings)
            .then(function (provider) { return provider.prompt(); })
            .then(function (newAccount) { return _this.store.addOrUpdate(newAccount); });
    };
    AccountManager.prototype.refresh = function (account) {
        var _this = this;
        return this.getProvider(account.key.providerId, account.key.providerArgs)
            .then(function (provider) { return provider.refresh(account); })
            .then(function (refreshedAccount) { return _this.store.addOrUpdate(refreshedAccount); });
    };
    AccountManager.prototype.remove = function (account) {
        var _this = this;
        return this.getProvider(account.key.providerId, account.key.providerArgs).then(function (provider) {
            return _this.store.remove(account.key).then(function (result) {
                if (!result) {
                    return false;
                }
                return provider.clear(account).then(function () { return true; });
            });
        });
    };
    return AccountManager;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = AccountManager;

//# sourceMappingURL=data:application/json;base64,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QyxLQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTTtnQkFDN0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNWLE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ2pCLENBQUM7Z0JBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQU0sT0FBQSxJQUFJLEVBQUosQ0FBSSxDQUFDLENBQUM7WUFDcEQsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDTCxxQkFBQztBQUFELENBakdBLEFBaUdDLElBQUEiLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiBDb3B5cmlnaHQgKEMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuaW1wb3J0IHsgUHJvbWlzZSB9IGZyb20gXCJxXCI7XHJcbmltcG9ydCAqIGFzIFEgZnJvbSBcInFcIjtcclxuXHJcbmltcG9ydCAqIGFzIGluZGV4IGZyb20gXCIuL2luZGV4XCI7XHJcblxyXG4vKipcclxuICogUmVwcmVzZW50cyBhIHN0b3JlIGZvciBhY2NvdW50cyBmb3IgdXNlIHdpdGggdGhlIGRlZmF1bHQgYWNjb3VudCBtYW5hZ2VyLlxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBBY2NvdW50U3RvcmUgZXh0ZW5kcyBpbmRleC5BY2NvdW50U3RvcmUge1xyXG4gICAgLyoqXHJcbiAgICAgKiBBZGRzIG9yIHVwZGF0ZXMgYW4gYWNjb3VudCBwcm9kdWNlZCBieSBhbiBhY2NvdW50IHByb3ZpZGVyLlxyXG4gICAgICogUmV0dXJucyBhIG5ldyB1cGRhdGVkIGFjY291bnQgaW5zdGFuY2UuXHJcbiAgICAgKiBAcGFyYW0gYWNjb3VudCAtIEFuIGFjY291bnQuXHJcbiAgICAgKi9cclxuICAgIGFkZE9yVXBkYXRlKGFjY291bnQ6IGluZGV4LkFjY291bnQpOiBQcm9taXNlPGluZGV4LkFjY291bnQ+O1xyXG4gICAgLyoqXHJcbiAgICAgKiBVcGRhdGVzIHRoZSBzdGF0ZSBvZiBhbiBhY2NvdW50IHdoZW4gYW4gYWNjb3VudCBwcm92aWRlciBpbmRpY2F0ZWQgaXQgYmVjYW1lIHN0YWxlLlxyXG4gICAgICogUmV0dXJucyBudWxsIGlmIG5vIGFjY291bnQgd2FzIGZvdW5kIHRvIHVwZGF0ZS5cclxuICAgICAqIE90aGVyd2lzZSwgcmV0dXJucyBhIG5ldyB1cGRhdGVkIGFjY291bnQgaW5zdGFuY2UuXHJcbiAgICAgKiBAcGFyYW0ga2V5IC0gVGhlIGtleSBvZiBhbiBhY2NvdW50LlxyXG4gICAgICogQHBhcmFtIHN0YWxlIC0gVGhlIHVwZGF0ZWQgdmFsdWUgb2YgdGhlIHN0YWxlIHByb3BlcnR5IGZvciB0aGUgYWNjb3VudC5cclxuICAgICAqL1xyXG4gICAgdXBkYXRlU3RhdGUoa2V5OiBpbmRleC5BY2NvdW50S2V5LCBzdGFsZTogYm9vbGVhbik6IFByb21pc2U8aW5kZXguQWNjb3VudD47XHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZXMgYW4gYWNjb3VudC5cclxuICAgICAqIFJldHVybnMgZmFsc2UgaWYgdGhlIGFjY291bnQgd2FzIG5vdCBmb3VuZC5cclxuICAgICAqIE90aGVyd2lzZSwgcmV0dXJucyB0cnVlLlxyXG4gICAgICogQHBhcmFtIGtleSAtIFRoZSBrZXkgb2YgYW4gYWNjb3VudC5cclxuICAgICAqL1xyXG4gICAgcmVtb3ZlKGtleTogaW5kZXguQWNjb3VudEtleSk6IFByb21pc2U8Ym9vbGVhbj47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZXByZXNlbnRzIGEgbGlzdGVuZXIgdGhhdCBpcyBjYWxsZWQgd2hlbiBhbiBhY2NvdW50IGJlY29tZXMgc3RhbGUuXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEFjY291bnRTdGFsZUxpc3RlbmVyIHtcclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyB0aGUgZXZlbnQgb2YgYW4gYWNjb3VudCBiZWNvbWluZyBzdGFsZS5cclxuICAgICAqIEBwYXJhbSBhY2NvdW50IC0gQW4gYWNjb3VudC5cclxuICAgICAqL1xyXG4gICAgKGFjY291bnQ6IGluZGV4LkFjY291bnQpOiB2b2lkO1xyXG59XHJcblxyXG4vKipcclxuICogUmVwcmVzZW50cyBhIHByb3ZpZGVyIG9mIGFjY291bnRzIGZvciB1c2Ugd2l0aCB0aGUgZGVmYXVsdCBhY2NvdW50IG1hbmFnZXIuXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEFjY291bnRQcm92aWRlciBleHRlbmRzIGluZGV4LkFjY291bnRQcm92aWRlciwgTm9kZUpTLkV2ZW50RW1pdHRlciB7XHJcbiAgICAvKipcclxuICAgICAqIFByb21wdHMgdGhlIHVzZXIgdG8gZW50ZXIgYWNjb3VudCBpbmZvcm1hdGlvbi5cclxuICAgICAqIFJldHVybnMgYW4gZXJyb3IgaWYgdGhlIHVzZXIgY2FuY2VsZWQgdGhlIG9wZXJhdGlvbi5cclxuICAgICAqL1xyXG4gICAgcHJvbXB0KCk6IFByb21pc2U8aW5kZXguQWNjb3VudD47XHJcbiAgICAvKipcclxuICAgICAqIFJlZnJlc2hlcyBhIHN0YWxlIGFjY291bnQuXHJcbiAgICAgKiBSZXR1cm5zIGFuIGVycm9yIGlmIHRoZSB1c2VyIGNhbmNlbGVkIHRoZSBvcGVyYXRpb24uXHJcbiAgICAgKiBPdGhlcndpc2UsIHJldHVybnMgYSBuZXcgdXBkYXRlZCBhY2NvdW50IGluc3RhbmNlLlxyXG4gICAgICogQHBhcmFtIGFjY291bnQgLSBBbiBhY2NvdW50LlxyXG4gICAgICovXHJcbiAgICByZWZyZXNoKGFjY291bnQ6IGluZGV4LkFjY291bnQpOiBQcm9taXNlPGluZGV4LkFjY291bnQ+O1xyXG4gICAgLyoqXHJcbiAgICAgKiBDbGVhcnMgc2Vuc2l0aXZlIGluZm9ybWF0aW9uIGZvciBhbiBhY2NvdW50LlxyXG4gICAgICogQHBhcmFtIGFjY291bnQgLSBBbiBhY2NvdW50LlxyXG4gICAgICovXHJcbiAgICBjbGVhcihhY2NvdW50OiBpbmRleC5BY2NvdW50KTogUHJvbWlzZTx2b2lkPjtcclxuICAgIGFkZExpc3RlbmVyKGV2ZW50OiBcInN0YWxlXCIsIGxpc3RlbmVyOiBBY2NvdW50U3RhbGVMaXN0ZW5lcik6IHRoaXM7XHJcbiAgICBhZGRMaXN0ZW5lcihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pOiB0aGlzO1xyXG4gICAgb24oZXZlbnQ6IFwic3RhbGVcIiwgbGlzdGVuZXI6IEFjY291bnRTdGFsZUxpc3RlbmVyKTogdGhpcztcclxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiBGdW5jdGlvbik6IHRoaXM7XHJcbiAgICBvbmNlKGV2ZW50OiBcInN0YWxlXCIsIGxpc3RlbmVyOiBBY2NvdW50U3RhbGVMaXN0ZW5lcik6IHRoaXM7XHJcbiAgICBvbmNlKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiBGdW5jdGlvbik6IHRoaXM7XHJcbiAgICByZW1vdmVMaXN0ZW5lcihldmVudDogXCJzdGFsZVwiLCBsaXN0ZW5lcjogQWNjb3VudFN0YWxlTGlzdGVuZXIpOiB0aGlzO1xyXG4gICAgcmVtb3ZlTGlzdGVuZXIoZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6IEZ1bmN0aW9uKTogdGhpcztcclxuICAgIGxpc3RlbmVycyhldmVudDogXCJzdGFsZVwiKTogQWNjb3VudFN0YWxlTGlzdGVuZXJbXTtcclxuICAgIGxpc3RlbmVycyhldmVudDogc3RyaW5nKTogRnVuY3Rpb25bXTtcclxuICAgIGVtaXQoZXZlbnQ6IFwic3RhbGVcIiwgYWNjb3VudDogaW5kZXguQWNjb3VudCk6IGJvb2xlYW47XHJcbiAgICBlbWl0KGV2ZW50OiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKTogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWNjb3VudE1hbmFnZXIgaW1wbGVtZW50cyBpbmRleC5BY2NvdW50TWFuYWdlciB7XHJcbiAgICBwdWJsaWMgc3RvcmU6IEFjY291bnRTdG9yZTtcclxuICAgIHByaXZhdGUgcHJvdmlkZXJzOiBBY2NvdW50UHJvdmlkZXJbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm92aWRlcnM6IEFjY291bnRQcm92aWRlcltdLCBzdG9yZT86IEFjY291bnRTdG9yZSkge1xyXG4gICAgICAgIC8qIHRzbGludDpkaXNhYmxlIG5vLXJlcXVpcmUtaW1wb3J0cyAqL1xyXG4gICAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZSB8fCBuZXcgKHJlcXVpcmUoXCIuL3N0b3JlL2luTWVtb3J5XCIpLmRlZmF1bHQpKCk7XHJcbiAgICAgICAgLyogdHNsaW50OmVuYWJsZSAqL1xyXG5cclxuICAgICAgICB0aGlzLnByb3ZpZGVycyA9IHByb3ZpZGVycztcclxuICAgICAgICB0aGlzLnByb3ZpZGVycy5mb3JFYWNoKHByb3ZpZGVyID0+IHByb3ZpZGVyLm9uKFwic3RhbGVcIiwgYWNjb3VudCA9PiB0aGlzLnN0b3JlLnVwZGF0ZVN0YXRlKGFjY291bnQua2V5LCB0cnVlKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBxdWVyeVByb3ZpZGVycyhxdWVyeT86IGluZGV4LkFjY291bnRQcm92aWRlclF1ZXJ5KSB7XHJcbiAgICAgICAgcXVlcnkgPSBxdWVyeSB8fCB7fTtcclxuICAgICAgICByZXR1cm4gUS5yZXNvbHZlKHRoaXMucHJvdmlkZXJzLmZpbHRlcihwcm92aWRlciA9PiB7XHJcbiAgICAgICAgICAgIC8vIEZpbHRlciBvbiB0aGUgcHJvdmlkZXIgSUQgaWYgc3VwcGxpZWRcclxuICAgICAgICAgICAgaWYgKHF1ZXJ5LmlkICYmIHByb3ZpZGVyLmlkICE9PSBxdWVyeS5pZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBGaWx0ZXIgb24gdGhlIHByb3ZpZGVyIGFyZ3VtZW50cyBpZiBzdXBwbGllZFxyXG4gICAgICAgICAgICBpZiAocXVlcnkuYXJncykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFwcm92aWRlci5hcmdzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHF1ZXJ5LmFyZ3MpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocHJvdmlkZXIuYXJnc1trZXldICE9PSBxdWVyeS5hcmdzW2tleV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gRmlsdGVyIG9uIHRoZSBwcm92aWRlciBzZXR0aW5ncyBpZiBzdXBwbGllZFxyXG4gICAgICAgICAgICBpZiAocXVlcnkuc2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgIGlmICghcHJvdmlkZXIuc2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gcXVlcnkuc2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3ZpZGVyLnNldHRpbmdzW2tleV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc29tZSBzZXR0aW5ncyBhcmUgcmVzb3VyY2VzIHdoaWNoIGhhdmUgaWRzIGFuZCBlbmRwb2ludHMsIGNoZWNrIGlmIHRoYXQgaXMgdGhlIGNhc2UgZmlyc3RcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISFxdWVyeS5zZXR0aW5nc1trZXldLmlkIHx8ICEhcXVlcnkuc2V0dGluZ3Nba2V5XS5lbmRwb2ludCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXR0aW5nIGlzIGEgcmVzb3VyY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEhcXVlcnkuc2V0dGluZ3Nba2V5XS5pZCAmJiBwcm92aWRlci5zZXR0aW5nc1trZXldLmlkICE9PSBxdWVyeS5zZXR0aW5nc1trZXldLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXR0aW5nIGhhZCBhbiBpZCwgYW5kIHRoZSBpZCBvZiB0aGUgc2FtZSBzZXR0aW5nIG9uIHRoZSBwcm92aWRlciBkaWRuJ3QgbWF0Y2hcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoISFxdWVyeS5zZXR0aW5nc1trZXldLmVuZHBvaW50ICYmIHByb3ZpZGVyLnNldHRpbmdzW2tleV0uZW5kcG9pbnQgIT09IHF1ZXJ5LnNldHRpbmdzW2tleV0uZW5kcG9pbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldHRpbmcgaGFkIGFuIGVuZHBvaW50LCBhbmQgdGhlIGVuZHBvaW50IG9mIHRoZSBzYW1lIHNldHRpbmcgb24gdGhlIHByb3ZpZGVyIGRpZG4ndCBtYXRjaFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm92aWRlci5zZXR0aW5nc1trZXldICE9PSBxdWVyeS5zZXR0aW5nc1trZXldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0UHJvdmlkZXI8VCBleHRlbmRzIGluZGV4LkFjY291bnRQcm92aWRlcj4oaWQ6IHN0cmluZywgYXJncz86IHt9LCBzZXR0aW5ncz86IHt9KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlQcm92aWRlcnMoeyBpZCwgYXJncywgc2V0dGluZ3MgfSkudGhlbihwcm92aWRlcnMgPT4ge1xyXG4gICAgICAgICAgICBpZiAocHJvdmlkZXJzLmxlbmd0aCAhPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFEucmVqZWN0PFQ+KG5ldyBFcnJvcihcIlVubWF0Y2hlZCBvciBhbWJpZ3VvdXMgYWNjb3VudCBwcm92aWRlci5cIikpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gPFQ+PGFueT5wcm92aWRlcnNbMF07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFkZChwcm92aWRlcklkPzogc3RyaW5nLCBwcm92aWRlckFyZ3M/OiB7fSwgcHJvdmlkZXJTZXR0aW5ncz86IHt9KTogUHJvbWlzZTxpbmRleC5BY2NvdW50PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UHJvdmlkZXI8QWNjb3VudFByb3ZpZGVyPihwcm92aWRlcklkLCBwcm92aWRlckFyZ3MsIHByb3ZpZGVyU2V0dGluZ3MpXHJcbiAgICAgICAgICAgIC50aGVuKHByb3ZpZGVyID0+IHByb3ZpZGVyLnByb21wdCgpKVxyXG4gICAgICAgICAgICAudGhlbihuZXdBY2NvdW50ID0+IHRoaXMuc3RvcmUuYWRkT3JVcGRhdGUobmV3QWNjb3VudCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZWZyZXNoKGFjY291bnQ6IGluZGV4LkFjY291bnQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcm92aWRlcjxBY2NvdW50UHJvdmlkZXI+KGFjY291bnQua2V5LnByb3ZpZGVySWQsIGFjY291bnQua2V5LnByb3ZpZGVyQXJncylcclxuICAgICAgICAgICAgLnRoZW4ocHJvdmlkZXIgPT4gcHJvdmlkZXIucmVmcmVzaChhY2NvdW50KSlcclxuICAgICAgICAgICAgLnRoZW4ocmVmcmVzaGVkQWNjb3VudCA9PiB0aGlzLnN0b3JlLmFkZE9yVXBkYXRlKHJlZnJlc2hlZEFjY291bnQpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlKGFjY291bnQ6IGluZGV4LkFjY291bnQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQcm92aWRlcjxBY2NvdW50UHJvdmlkZXI+KGFjY291bnQua2V5LnByb3ZpZGVySWQsIGFjY291bnQua2V5LnByb3ZpZGVyQXJncykudGhlbihwcm92aWRlciA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLnJlbW92ZShhY2NvdW50LmtleSkudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyLmNsZWFyKGFjY291bnQpLnRoZW4oKCkgPT4gdHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
