/*!---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *----------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var events_1 = require("events");
var q_1 = require("q");
var Q = require("q");
function select(accounts, providerId, providerArgs, accountId) {
    var indexes = [];
    accounts.forEach(function (account, index) {
        // Filter on the provider ID if supplied
        if (providerId && account.key.providerId !== providerId) {
            return;
        }
        // Filter on the provider arguments if supplied
        if (providerArgs) {
            if (!account.key.providerArgs) {
                return;
            }
            for (var key in providerArgs) {
                if (account.key.providerArgs[key] !== providerArgs[key]) {
                    return;
                }
            }
        }
        // Filter on the account ID if supplied
        if (accountId && account.key.accountId !== accountId) {
            return;
        }
        indexes.push(index);
    });
    return indexes;
}
function insert(accounts, account) {
    accounts.push(account);
    return account;
}
function merge(account, displayInfo, properties, stale) {
    var newAccount = {
        key: account.key,
        name: account.name,
        displayInfo: account.displayInfo,
        properties: account.properties,
        stale: account.stale
    }, hasChanges = false;
    // Take any display info changes
    if (displayInfo && account.displayInfo !== displayInfo) {
        if (account.displayInfo.contextualLogo !== displayInfo.contextualLogo ||
            account.displayInfo.contextualDisplayName !== displayInfo.contextualDisplayName ||
            account.displayInfo.displayName !== displayInfo.displayName) {
            newAccount.displayInfo = displayInfo;
            hasChanges = true;
        }
    }
    // Merge any changes to the properties
    if (properties && account.properties !== properties) {
        // Make a shallow copy of the original properties, if any
        newAccount.properties = {};
        if (account.properties) {
            for (var key in account.properties) {
                if (Object.prototype.hasOwnProperty.call(account.properties, key)) {
                    newAccount.properties[key] = account.properties[key];
                }
            }
        }
        // Add new properties or update or remove original properties
        for (var key in properties) {
            if (typeof properties[key] !== "undefined") {
                // TODO: recursively check arrays and objects for equality
                if (newAccount.properties[key] !== properties[key]) {
                    // Add new property or update original property
                    newAccount.properties[key] = properties[key];
                    hasChanges = true;
                }
            }
            else {
                // Remove original property
                delete newAccount.properties[key];
                hasChanges = true;
            }
        }
    }
    // Take any state changes
    if (typeof stale === "boolean") {
        if (account.stale !== stale) {
            newAccount.stale = stale;
            hasChanges = true;
        }
    }
    return hasChanges ? newAccount : null;
}
function update(accounts, index, displayInfo, properties, stale) {
    var updatedAccount = merge(accounts[index], displayInfo, properties, stale);
    if (updatedAccount) {
        accounts[index] = updatedAccount;
    }
    return accounts[index];
}
function sync(baseline, latest, store) {
    if (!baseline) {
        // No baseline yet; take the latest
        return latest;
    }
    var changes = {
        added: [],
        modified: [],
        removed: []
    }, result = [];
    // Handle new and modified accounts
    for (var i = 0; i < latest.length; i++) {
        var key = latest[i].key, indexes = select(baseline, key.providerId, key.providerArgs, key.accountId);
        if (!indexes.length) {
            // Account only exists in latest
            changes.added.push(latest[i]);
            result.push(latest[i]);
        }
        else {
            // Account exists in baseline and latest
            var baselineAccount = baseline[indexes[0]], mergedAccount = merge(baselineAccount, latest[i].displayInfo, latest[i].properties, latest[i].stale);
            if (mergedAccount) {
                // Baseline and latest accounts differed and produced a new, merged account
                changes.modified.push({ before: baselineAccount, after: mergedAccount });
            }
            result.push(mergedAccount || baselineAccount);
        }
    }
    // Handle deleted accounts
    for (var i = 0; i < baseline.length; i++) {
        var key = baseline[i].key, indexes = select(latest, key.providerId, key.providerArgs, key.accountId);
        if (!indexes.length) {
            // Account only exists in baseline
            changes.removed.push(baseline[i]);
        }
    }
    // Asynchronously emit change event if there were any changes
    if (changes.added.length || changes.modified.length || changes.removed.length) {
        setTimeout(function () { return store.emit("change", changes); }, 0);
    }
    // Return the new baseline
    return result;
}
var AccountStore = (function (_super) {
    __extends(AccountStore, _super);
    function AccountStore() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    AccountStore.prototype.doOperation = function (op) {
        var _this = this;
        var activeOperation = this.activeOperation || Q.resolve(null);
        activeOperation = activeOperation.then(op).fin(function () {
            if (_this.activeOperation === activeOperation) {
                _this.activeOperation = null;
            }
        });
        this.activeOperation = activeOperation;
        return this.activeOperation;
    };
    AccountStore.prototype.getAccounts = function (refresh) {
        var _this = this;
        if (!this.baseline || refresh) {
            // Read accounts and refresh baseline
            return this.readAccounts().then(function (accounts) {
                _this.baseline = sync(_this.baseline, accounts, _this);
                return _this.baseline;
            });
        }
        return Q.resolve(this.baseline);
    };
    AccountStore.prototype.query = function (query) {
        var _this = this;
        query = query || {};
        return this.doOperation(function () { return _this.getAccounts().then(function (accounts) {
            return select(accounts, query.providerId, query.providerArgs, query.accountId).map(function (i) { return accounts[i]; });
        }); });
    };
    AccountStore.prototype.mutateAccounts = function (mutate) {
        var _this = this;
        // A mutation first refreshes the baseline with the latest accounts
        // and then applies the mutation operation on top of this baseline.
        return this.doOperation(function () { return _this.getAccounts(true).then(function (accounts) {
            // Shallow copy the accounts array before the mutation
            // so that it is an isolated mutation until committed.
            var result = mutate(accounts = accounts.slice());
            return _this.writeAccounts(accounts).then(function () {
                // Update the baseline with the mutated accounts
                _this.baseline = sync(_this.baseline, accounts, _this);
                return result;
            });
        }); });
    };
    AccountStore.prototype.addOrUpdate = function (account) {
        return this.mutateAccounts(function (accounts) {
            var key = account.key, indexes = select(accounts, key.providerId, key.providerArgs, key.accountId);
            if (indexes.length > 1) {
                // Cannot update multiple accounts
                return null;
            }
            if (!indexes.length) {
                // No matching account found; insert new one
                return insert(accounts, account);
            }
            else {
                // Update the matching account
                return update(accounts, indexes[0], account.displayInfo, account.properties, account.stale);
            }
        });
    };
    AccountStore.prototype.updateAccount = function (key, displayInfo, properties, stale) {
        return this.mutateAccounts(function (accounts) {
            var indexes = select(accounts, key.providerId, key.providerArgs, key.accountId);
            if (indexes.length !== 1) {
                // No matching account found to update
                return null;
            }
            return update(accounts, indexes[0], displayInfo, properties, stale);
        });
    };
    AccountStore.prototype.updateDisplayInfo = function (key, displayInfo) {
        return this.updateAccount(key, displayInfo);
    };
    AccountStore.prototype.updateProperties = function (key, properties) {
        return this.updateAccount(key, null, properties);
    };
    AccountStore.prototype.updateState = function (key, stale) {
        return this.updateAccount(key, null, null, stale);
    };
    AccountStore.prototype.remove = function (key) {
        var _this = this;
        return q_1.Promise(function (resolve) {
            return _this.mutateAccounts(function (accounts) {
                var indexes = select(accounts, key.providerId, key.providerArgs, key.accountId);
                if (indexes.length !== 1) {
                    // No matching account found to remove
                    resolve(false);
                }
                accounts.splice(indexes[0], 1);
                resolve(true);
            });
        });
    };
    AccountStore.prototype.onAccountsChanged = function () {
        var _this = this;
        // Refresh the list of accounts, which will synchronize the baseline,
        // which will emit a change event if any changes were actually made.
        this.doOperation(function () { return _this.getAccounts(true); });
    };
    AccountStore.prototype.addListener = function (event, listener) {
        return _super.prototype.addListener.call(this, event, listener);
    };
    AccountStore.prototype.listeners = function (event) {
        return _super.prototype.listeners.call(this, event);
    };
    return AccountStore;
}(events_1.EventEmitter));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = AccountStore;

//# sourceMappingURL=data:application/json;base64,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SyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFTSxnQ0FBUyxHQUFoQixVQUFpQixLQUFlO1FBQzVCLE1BQU0sQ0FBcUMsaUJBQU0sU0FBUyxZQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFFTCxtQkFBQztBQUFELENBOUhBLEFBOEhDLENBOUhtQyxxQkFBWSxHQThIL0M7O0FBRUQsa0JBQWUsWUFBWSxDQUFDIiwiZmlsZSI6InN0b3JlL2Jhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiEtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogQ29weXJpZ2h0IChDKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcclxuaW1wb3J0IHsgUHJvbWlzZSB9IGZyb20gXCJxXCI7XHJcbmltcG9ydCAqIGFzIFEgZnJvbSBcInFcIjtcclxuXHJcbmltcG9ydCAqIGFzIGluZGV4IGZyb20gXCIuLi9pbmRleFwiO1xyXG5pbXBvcnQgKiBhcyBtYW5hZ2VyIGZyb20gXCIuLi9tYW5hZ2VyXCI7XHJcblxyXG5mdW5jdGlvbiBzZWxlY3QoYWNjb3VudHM6IGluZGV4LkFjY291bnRbXSwgcHJvdmlkZXJJZD86IHN0cmluZywgcHJvdmlkZXJBcmdzPzogYW55LCBhY2NvdW50SWQ/OiBzdHJpbmcpIHtcclxuICAgIGxldCBpbmRleGVzOiBudW1iZXJbXSA9IFtdO1xyXG5cclxuICAgIGFjY291bnRzLmZvckVhY2goKGFjY291bnQsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgLy8gRmlsdGVyIG9uIHRoZSBwcm92aWRlciBJRCBpZiBzdXBwbGllZFxyXG4gICAgICAgIGlmIChwcm92aWRlcklkICYmIGFjY291bnQua2V5LnByb3ZpZGVySWQgIT09IHByb3ZpZGVySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gRmlsdGVyIG9uIHRoZSBwcm92aWRlciBhcmd1bWVudHMgaWYgc3VwcGxpZWRcclxuICAgICAgICBpZiAocHJvdmlkZXJBcmdzKSB7XHJcbiAgICAgICAgICAgIGlmICghYWNjb3VudC5rZXkucHJvdmlkZXJBcmdzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHByb3ZpZGVyQXJncykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGFjY291bnQua2V5LnByb3ZpZGVyQXJnc1trZXldICE9PSBwcm92aWRlckFyZ3Nba2V5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gRmlsdGVyIG9uIHRoZSBhY2NvdW50IElEIGlmIHN1cHBsaWVkXHJcbiAgICAgICAgaWYgKGFjY291bnRJZCAmJiBhY2NvdW50LmtleS5hY2NvdW50SWQgIT09IGFjY291bnRJZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpbmRleGVzLnB1c2goaW5kZXgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGluZGV4ZXM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluc2VydChhY2NvdW50czogaW5kZXguQWNjb3VudFtdLCBhY2NvdW50OiBpbmRleC5BY2NvdW50KSB7XHJcbiAgICBhY2NvdW50cy5wdXNoKGFjY291bnQpO1xyXG4gICAgcmV0dXJuIGFjY291bnQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1lcmdlKGFjY291bnQ6IGluZGV4LkFjY291bnQsIGRpc3BsYXlJbmZvOiBpbmRleC5BY2NvdW50RGlzcGxheUluZm8sIHByb3BlcnRpZXM6IGFueSwgc3RhbGU6IGJvb2xlYW4pIHtcclxuICAgIGxldCBuZXdBY2NvdW50ID0gPGluZGV4LkFjY291bnQ+e1xyXG4gICAgICAgIGtleTogYWNjb3VudC5rZXksXHJcbiAgICAgICAgbmFtZTogYWNjb3VudC5uYW1lLFxyXG4gICAgICAgIGRpc3BsYXlJbmZvOiBhY2NvdW50LmRpc3BsYXlJbmZvLFxyXG4gICAgICAgIHByb3BlcnRpZXM6IGFjY291bnQucHJvcGVydGllcyxcclxuICAgICAgICBzdGFsZTogYWNjb3VudC5zdGFsZVxyXG4gICAgfSwgaGFzQ2hhbmdlcyA9IGZhbHNlO1xyXG5cclxuICAgIC8vIFRha2UgYW55IGRpc3BsYXkgaW5mbyBjaGFuZ2VzXHJcbiAgICBpZiAoZGlzcGxheUluZm8gJiYgYWNjb3VudC5kaXNwbGF5SW5mbyAhPT0gZGlzcGxheUluZm8pIHtcclxuICAgICAgICBpZiAoYWNjb3VudC5kaXNwbGF5SW5mby5jb250ZXh0dWFsTG9nbyAhPT0gZGlzcGxheUluZm8uY29udGV4dHVhbExvZ28gfHxcclxuICAgICAgICAgICAgYWNjb3VudC5kaXNwbGF5SW5mby5jb250ZXh0dWFsRGlzcGxheU5hbWUgIT09IGRpc3BsYXlJbmZvLmNvbnRleHR1YWxEaXNwbGF5TmFtZSB8fFxyXG4gICAgICAgICAgICBhY2NvdW50LmRpc3BsYXlJbmZvLmRpc3BsYXlOYW1lICE9PSBkaXNwbGF5SW5mby5kaXNwbGF5TmFtZSkge1xyXG4gICAgICAgICAgICBuZXdBY2NvdW50LmRpc3BsYXlJbmZvID0gZGlzcGxheUluZm87XHJcbiAgICAgICAgICAgIGhhc0NoYW5nZXMgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBNZXJnZSBhbnkgY2hhbmdlcyB0byB0aGUgcHJvcGVydGllc1xyXG4gICAgaWYgKHByb3BlcnRpZXMgJiYgYWNjb3VudC5wcm9wZXJ0aWVzICE9PSBwcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgLy8gTWFrZSBhIHNoYWxsb3cgY29weSBvZiB0aGUgb3JpZ2luYWwgcHJvcGVydGllcywgaWYgYW55XHJcbiAgICAgICAgbmV3QWNjb3VudC5wcm9wZXJ0aWVzID0ge307XHJcbiAgICAgICAgaWYgKGFjY291bnQucHJvcGVydGllcykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gYWNjb3VudC5wcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFjY291bnQucHJvcGVydGllcywga2V5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0FjY291bnQucHJvcGVydGllc1trZXldID0gYWNjb3VudC5wcm9wZXJ0aWVzW2tleV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEFkZCBuZXcgcHJvcGVydGllcyBvciB1cGRhdGUgb3IgcmVtb3ZlIG9yaWdpbmFsIHByb3BlcnRpZXNcclxuICAgICAgICBmb3IgKGxldCBrZXkgaW4gcHJvcGVydGllcykge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHByb3BlcnRpZXNba2V5XSAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogcmVjdXJzaXZlbHkgY2hlY2sgYXJyYXlzIGFuZCBvYmplY3RzIGZvciBlcXVhbGl0eVxyXG4gICAgICAgICAgICAgICAgaWYgKG5ld0FjY291bnQucHJvcGVydGllc1trZXldICE9PSBwcm9wZXJ0aWVzW2tleV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBBZGQgbmV3IHByb3BlcnR5IG9yIHVwZGF0ZSBvcmlnaW5hbCBwcm9wZXJ0eVxyXG4gICAgICAgICAgICAgICAgICAgIG5ld0FjY291bnQucHJvcGVydGllc1trZXldID0gcHJvcGVydGllc1trZXldO1xyXG4gICAgICAgICAgICAgICAgICAgIGhhc0NoYW5nZXMgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gUmVtb3ZlIG9yaWdpbmFsIHByb3BlcnR5XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgbmV3QWNjb3VudC5wcm9wZXJ0aWVzW2tleV07XHJcbiAgICAgICAgICAgICAgICBoYXNDaGFuZ2VzID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBUYWtlIGFueSBzdGF0ZSBjaGFuZ2VzXHJcbiAgICBpZiAodHlwZW9mIHN0YWxlID09PSBcImJvb2xlYW5cIikge1xyXG4gICAgICAgIGlmIChhY2NvdW50LnN0YWxlICE9PSBzdGFsZSkge1xyXG4gICAgICAgICAgICBuZXdBY2NvdW50LnN0YWxlID0gc3RhbGU7XHJcbiAgICAgICAgICAgIGhhc0NoYW5nZXMgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gaGFzQ2hhbmdlcyA/IG5ld0FjY291bnQgOiBudWxsO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGUoYWNjb3VudHM6IGluZGV4LkFjY291bnRbXSwgaW5kZXg6IG51bWJlciwgZGlzcGxheUluZm86IGluZGV4LkFjY291bnREaXNwbGF5SW5mbywgcHJvcGVydGllczogYW55LCBzdGFsZTogYm9vbGVhbikge1xyXG4gICAgbGV0IHVwZGF0ZWRBY2NvdW50ID0gbWVyZ2UoYWNjb3VudHNbaW5kZXhdLCBkaXNwbGF5SW5mbywgcHJvcGVydGllcywgc3RhbGUpO1xyXG5cclxuICAgIGlmICh1cGRhdGVkQWNjb3VudCkge1xyXG4gICAgICAgIGFjY291bnRzW2luZGV4XSA9IHVwZGF0ZWRBY2NvdW50O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBhY2NvdW50c1tpbmRleF07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHN5bmMoYmFzZWxpbmU6IGluZGV4LkFjY291bnRbXSwgbGF0ZXN0OiBpbmRleC5BY2NvdW50W10sIHN0b3JlOiBpbmRleC5BY2NvdW50U3RvcmUpIHtcclxuICAgIGlmICghYmFzZWxpbmUpIHtcclxuICAgICAgICAvLyBObyBiYXNlbGluZSB5ZXQ7IHRha2UgdGhlIGxhdGVzdFxyXG4gICAgICAgIHJldHVybiBsYXRlc3Q7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGNoYW5nZXM6IGluZGV4LkFjY291bnRTdG9yZUNoYW5nZXMgPSB7XHJcbiAgICAgICAgYWRkZWQ6IFtdLFxyXG4gICAgICAgIG1vZGlmaWVkOiBbXSxcclxuICAgICAgICByZW1vdmVkOiBbXVxyXG4gICAgfSwgcmVzdWx0OiBpbmRleC5BY2NvdW50W10gPSBbXTtcclxuXHJcbiAgICAvLyBIYW5kbGUgbmV3IGFuZCBtb2RpZmllZCBhY2NvdW50c1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXRlc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBsZXQga2V5ID0gbGF0ZXN0W2ldLmtleSxcclxuICAgICAgICAgICAgaW5kZXhlcyA9IHNlbGVjdChiYXNlbGluZSwga2V5LnByb3ZpZGVySWQsIGtleS5wcm92aWRlckFyZ3MsIGtleS5hY2NvdW50SWQpO1xyXG5cclxuICAgICAgICBpZiAoIWluZGV4ZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIC8vIEFjY291bnQgb25seSBleGlzdHMgaW4gbGF0ZXN0XHJcbiAgICAgICAgICAgIGNoYW5nZXMuYWRkZWQucHVzaChsYXRlc3RbaV0pO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChsYXRlc3RbaV0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIEFjY291bnQgZXhpc3RzIGluIGJhc2VsaW5lIGFuZCBsYXRlc3RcclxuICAgICAgICAgICAgbGV0IGJhc2VsaW5lQWNjb3VudCA9IGJhc2VsaW5lW2luZGV4ZXNbMF1dLFxyXG4gICAgICAgICAgICAgICAgbWVyZ2VkQWNjb3VudCA9IG1lcmdlKGJhc2VsaW5lQWNjb3VudCwgbGF0ZXN0W2ldLmRpc3BsYXlJbmZvLCBsYXRlc3RbaV0ucHJvcGVydGllcywgbGF0ZXN0W2ldLnN0YWxlKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChtZXJnZWRBY2NvdW50KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBCYXNlbGluZSBhbmQgbGF0ZXN0IGFjY291bnRzIGRpZmZlcmVkIGFuZCBwcm9kdWNlZCBhIG5ldywgbWVyZ2VkIGFjY291bnRcclxuICAgICAgICAgICAgICAgIGNoYW5nZXMubW9kaWZpZWQucHVzaCh7IGJlZm9yZTogYmFzZWxpbmVBY2NvdW50LCBhZnRlcjogbWVyZ2VkQWNjb3VudCB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmVzdWx0LnB1c2gobWVyZ2VkQWNjb3VudCB8fCBiYXNlbGluZUFjY291bnQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBIYW5kbGUgZGVsZXRlZCBhY2NvdW50c1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiYXNlbGluZS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGxldCBrZXkgPSBiYXNlbGluZVtpXS5rZXksXHJcbiAgICAgICAgICAgIGluZGV4ZXMgPSBzZWxlY3QobGF0ZXN0LCBrZXkucHJvdmlkZXJJZCwga2V5LnByb3ZpZGVyQXJncywga2V5LmFjY291bnRJZCk7XHJcblxyXG4gICAgICAgIGlmICghaW5kZXhlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgLy8gQWNjb3VudCBvbmx5IGV4aXN0cyBpbiBiYXNlbGluZVxyXG4gICAgICAgICAgICBjaGFuZ2VzLnJlbW92ZWQucHVzaChiYXNlbGluZVtpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEFzeW5jaHJvbm91c2x5IGVtaXQgY2hhbmdlIGV2ZW50IGlmIHRoZXJlIHdlcmUgYW55IGNoYW5nZXNcclxuICAgIGlmIChjaGFuZ2VzLmFkZGVkLmxlbmd0aCB8fCBjaGFuZ2VzLm1vZGlmaWVkLmxlbmd0aCB8fCBjaGFuZ2VzLnJlbW92ZWQubGVuZ3RoKSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBzdG9yZS5lbWl0KFwiY2hhbmdlXCIsIGNoYW5nZXMpLCAwKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZXR1cm4gdGhlIG5ldyBiYXNlbGluZVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuYWJzdHJhY3QgY2xhc3MgQWNjb3VudFN0b3JlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIGltcGxlbWVudHMgbWFuYWdlci5BY2NvdW50U3RvcmUge1xyXG4gICAgcHJpdmF0ZSBiYXNlbGluZTogaW5kZXguQWNjb3VudFtdO1xyXG4gICAgcHJpdmF0ZSBhY3RpdmVPcGVyYXRpb246IFByb21pc2U8YW55PjtcclxuXHJcbiAgICBwcml2YXRlIGRvT3BlcmF0aW9uPFQ+KG9wOiAoKSA9PiBQcm9taXNlPFQ+KSB7XHJcbiAgICAgICAgbGV0IGFjdGl2ZU9wZXJhdGlvbiA9IHRoaXMuYWN0aXZlT3BlcmF0aW9uIHx8IFEucmVzb2x2ZTxhbnk+KG51bGwpO1xyXG4gICAgICAgIGFjdGl2ZU9wZXJhdGlvbiA9IGFjdGl2ZU9wZXJhdGlvbi50aGVuKG9wKS5maW4oKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVPcGVyYXRpb24gPT09IGFjdGl2ZU9wZXJhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVPcGVyYXRpb24gPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVPcGVyYXRpb24gPSBhY3RpdmVPcGVyYXRpb247XHJcbiAgICAgICAgcmV0dXJuIDxQcm9taXNlPFQ+PnRoaXMuYWN0aXZlT3BlcmF0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCByZWFkQWNjb3VudHMoKTtcclxuXHJcbiAgICBwcml2YXRlIGdldEFjY291bnRzKHJlZnJlc2g/OiBib29sZWFuKTogUHJvbWlzZTxpbmRleC5BY2NvdW50W10+IHtcclxuICAgICAgICBpZiAoIXRoaXMuYmFzZWxpbmUgfHwgcmVmcmVzaCkge1xyXG4gICAgICAgICAgICAvLyBSZWFkIGFjY291bnRzIGFuZCByZWZyZXNoIGJhc2VsaW5lXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlYWRBY2NvdW50cygpLnRoZW4oYWNjb3VudHMgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlbGluZSA9IHN5bmModGhpcy5iYXNlbGluZSwgYWNjb3VudHMsIHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmFzZWxpbmU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gUS5yZXNvbHZlKHRoaXMuYmFzZWxpbmUpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBxdWVyeShxdWVyeT86IGluZGV4LkFjY291bnRRdWVyeSk6IFByb21pc2U8aW5kZXguQWNjb3VudFtdPiB7XHJcbiAgICAgICAgcXVlcnkgPSBxdWVyeSB8fCB7fTtcclxuICAgICAgICByZXR1cm4gdGhpcy5kb09wZXJhdGlvbigoKSA9PiB0aGlzLmdldEFjY291bnRzKCkudGhlbihhY2NvdW50cyA9PlxyXG4gICAgICAgICAgICBzZWxlY3QoYWNjb3VudHMsIHF1ZXJ5LnByb3ZpZGVySWQsIHF1ZXJ5LnByb3ZpZGVyQXJncywgcXVlcnkuYWNjb3VudElkKS5tYXAoaSA9PiBhY2NvdW50c1tpXSkpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3Qgd3JpdGVBY2NvdW50cyhhY2NvdW50czogaW5kZXguQWNjb3VudFtdKTtcclxuXHJcbiAgICBwcml2YXRlIG11dGF0ZUFjY291bnRzPFQ+KG11dGF0ZTogKGFjY291bnRzOiBpbmRleC5BY2NvdW50W10pID0+IFQpOiBQcm9taXNlPGluZGV4LkFjY291bnQ+IHtcclxuICAgICAgICAvLyBBIG11dGF0aW9uIGZpcnN0IHJlZnJlc2hlcyB0aGUgYmFzZWxpbmUgd2l0aCB0aGUgbGF0ZXN0IGFjY291bnRzXHJcbiAgICAgICAgLy8gYW5kIHRoZW4gYXBwbGllcyB0aGUgbXV0YXRpb24gb3BlcmF0aW9uIG9uIHRvcCBvZiB0aGlzIGJhc2VsaW5lLlxyXG4gICAgICAgIHJldHVybiB0aGlzLmRvT3BlcmF0aW9uPGluZGV4LkFjY291bnQ+KCgpID0+IHRoaXMuZ2V0QWNjb3VudHModHJ1ZSkudGhlbihhY2NvdW50cyA9PiB7XHJcbiAgICAgICAgICAgIC8vIFNoYWxsb3cgY29weSB0aGUgYWNjb3VudHMgYXJyYXkgYmVmb3JlIHRoZSBtdXRhdGlvblxyXG4gICAgICAgICAgICAvLyBzbyB0aGF0IGl0IGlzIGFuIGlzb2xhdGVkIG11dGF0aW9uIHVudGlsIGNvbW1pdHRlZC5cclxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG11dGF0ZShhY2NvdW50cyA9IGFjY291bnRzLnNsaWNlKCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy53cml0ZUFjY291bnRzKGFjY291bnRzKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgYmFzZWxpbmUgd2l0aCB0aGUgbXV0YXRlZCBhY2NvdW50c1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlbGluZSA9IHN5bmModGhpcy5iYXNlbGluZSwgYWNjb3VudHMsIHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRPclVwZGF0ZShhY2NvdW50OiBpbmRleC5BY2NvdW50KTogUHJvbWlzZTxpbmRleC5BY2NvdW50PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubXV0YXRlQWNjb3VudHMoYWNjb3VudHMgPT4ge1xyXG4gICAgICAgICAgICBsZXQga2V5ID0gYWNjb3VudC5rZXksXHJcbiAgICAgICAgICAgICAgICBpbmRleGVzID0gc2VsZWN0KGFjY291bnRzLCBrZXkucHJvdmlkZXJJZCwga2V5LnByb3ZpZGVyQXJncywga2V5LmFjY291bnRJZCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoaW5kZXhlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDYW5ub3QgdXBkYXRlIG11bHRpcGxlIGFjY291bnRzXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFpbmRleGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgLy8gTm8gbWF0Y2hpbmcgYWNjb3VudCBmb3VuZDsgaW5zZXJ0IG5ldyBvbmVcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbnNlcnQoYWNjb3VudHMsIGFjY291bnQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBtYXRjaGluZyBhY2NvdW50XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlKGFjY291bnRzLCBpbmRleGVzWzBdLCBhY2NvdW50LmRpc3BsYXlJbmZvLCBhY2NvdW50LnByb3BlcnRpZXMsIGFjY291bnQuc3RhbGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVBY2NvdW50KGtleTogaW5kZXguQWNjb3VudEtleSwgZGlzcGxheUluZm8/OiBpbmRleC5BY2NvdW50RGlzcGxheUluZm8sIHByb3BlcnRpZXM/OiBhbnksIHN0YWxlPzogYm9vbGVhbikge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm11dGF0ZUFjY291bnRzKGFjY291bnRzID0+IHtcclxuICAgICAgICAgICAgbGV0IGluZGV4ZXMgPSBzZWxlY3QoYWNjb3VudHMsIGtleS5wcm92aWRlcklkLCBrZXkucHJvdmlkZXJBcmdzLCBrZXkuYWNjb3VudElkKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChpbmRleGVzLmxlbmd0aCAhPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgLy8gTm8gbWF0Y2hpbmcgYWNjb3VudCBmb3VuZCB0byB1cGRhdGVcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdXBkYXRlKGFjY291bnRzLCBpbmRleGVzWzBdLCBkaXNwbGF5SW5mbywgcHJvcGVydGllcywgc3RhbGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGRhdGVEaXNwbGF5SW5mbyhrZXk6IGluZGV4LkFjY291bnRLZXksIGRpc3BsYXlJbmZvOiBpbmRleC5BY2NvdW50RGlzcGxheUluZm8pIHtcclxuICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVBY2NvdW50KGtleSwgZGlzcGxheUluZm8pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGRhdGVQcm9wZXJ0aWVzKGtleTogaW5kZXguQWNjb3VudEtleSwgcHJvcGVydGllczogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQWNjb3VudChrZXksIG51bGwsIHByb3BlcnRpZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cGRhdGVTdGF0ZShrZXk6IGluZGV4LkFjY291bnRLZXksIHN0YWxlOiBib29sZWFuKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQWNjb3VudChrZXksIG51bGwsIG51bGwsIHN0YWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVtb3ZlKGtleTogaW5kZXguQWNjb3VudEtleSk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PlxyXG4gICAgICAgICAgICB0aGlzLm11dGF0ZUFjY291bnRzKGFjY291bnRzID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBpbmRleGVzID0gc2VsZWN0KGFjY291bnRzLCBrZXkucHJvdmlkZXJJZCwga2V5LnByb3ZpZGVyQXJncywga2V5LmFjY291bnRJZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ZXMubGVuZ3RoICE9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gTm8gbWF0Y2hpbmcgYWNjb3VudCBmb3VuZCB0byByZW1vdmVcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBhY2NvdW50cy5zcGxpY2UoaW5kZXhlc1swXSwgMSk7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIG9uQWNjb3VudHNDaGFuZ2VkKCkge1xyXG4gICAgICAgIC8vIFJlZnJlc2ggdGhlIGxpc3Qgb2YgYWNjb3VudHMsIHdoaWNoIHdpbGwgc3luY2hyb25pemUgdGhlIGJhc2VsaW5lLFxyXG4gICAgICAgIC8vIHdoaWNoIHdpbGwgZW1pdCBhIGNoYW5nZSBldmVudCBpZiBhbnkgY2hhbmdlcyB3ZXJlIGFjdHVhbGx5IG1hZGUuXHJcbiAgICAgICAgdGhpcy5kb09wZXJhdGlvbigoKSA9PiB0aGlzLmdldEFjY291bnRzKHRydWUpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYWRkTGlzdGVuZXIoZXZlbnQ6IFwiY2hhbmdlXCIsIGxpc3RlbmVyOiBpbmRleC5BY2NvdW50U3RvcmVDaGFuZ2VMaXN0ZW5lcik6IHRoaXMge1xyXG4gICAgICAgIHJldHVybiBzdXBlci5hZGRMaXN0ZW5lcihldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsaXN0ZW5lcnMoZXZlbnQ6IFwiY2hhbmdlXCIpOiBpbmRleC5BY2NvdW50U3RvcmVDaGFuZ2VMaXN0ZW5lcltdIHtcclxuICAgICAgICByZXR1cm4gPGluZGV4LkFjY291bnRTdG9yZUNoYW5nZUxpc3RlbmVyW10+c3VwZXIubGlzdGVuZXJzKGV2ZW50KTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEFjY291bnRTdG9yZTtcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
