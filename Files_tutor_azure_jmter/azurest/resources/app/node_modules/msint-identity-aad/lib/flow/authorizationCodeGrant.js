/*!---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *----------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var _ = require("underscore");
var adal = require("adal-node");
var q_1 = require("q");
var Q = require("q");
var URI = require("urijs");
var index = require("../index");
var provider_base_1 = require("../provider-base");
// Monkey patch the ADAL TokenRequest class to fix the fact that when you
// request a token from an authorization code, it doesn't update the cache.
// TODO: get this change pushed into the actual ADAL library for Node.
var TokenRequest = require("adal-node/lib/token-request");
var getTokenWithAuthorizationCodeOriginal = TokenRequest.prototype.getTokenWithAuthorizationCode;
TokenRequest.prototype.getTokenWithAuthorizationCode = function (authorizationCode, clientSecret, callback) {
    var _this = this;
    this._cacheDriver = this._createCacheDriver();
    getTokenWithAuthorizationCodeOriginal.call(this, authorizationCode, clientSecret, function (error, response) {
        if (error) {
            callback(error, response);
        }
        else {
            _this._userId = response.userId;
            _this._cacheDriver.add(response, function () { return callback(null, response); });
        }
    });
};
var Provider = (function (_super) {
    __extends(Provider, _super);
    function Provider(getAuthorizationCode, settings, tokenCache) {
        var _this = _super.call(this, _.extend({}, index.defaultAuthorizationCodeGrantFlowSettings, settings), tokenCache) || this;
        _this.getAuthorizationCode = getAuthorizationCode;
        return _this;
    }
    Provider.prototype.authenticate = function (tenantId, msa, userId, silent) {
        var _this = this;
        var authorityUrl = this.settings.host + "/" + tenantId, authorizeUrl = authorityUrl + "/oauth2/authorize" +
            // Specify the client ID, request the authorization code grant flow
            "?client_id=" + this.settings.clientId + "&response_type=code" +
            // Specify settings to optimize prompt given existing MSA or Org ID
            (userId ? (msa ? "&domain_hint=live.com" : "&msafed=0") : "") +
            // Specify settings to require login and/or provide existing user as a hint
            ((!userId || !silent) ? "&prompt=login" : "") +
            (userId ? ("&login_hint=" + encodeURIComponent(userId)) : "") +
            // The site ID can be used to brand the prompt in some form
            (this.settings.siteId ? ("&site_id=" + this.settings.siteId) : "") +
            // The display=popup setting causes a popup version of the UI to be shown
            "&display=popup" +
            // Not sure what the nux=1 setting does, but it was in the VS keychain
            "&nux=1" +
            // Specify the resource for which an access token should be retrieved
            "&resource=" + encodeURIComponent(this.settings.signInResourceId) +
            // TODO: add locale parameter like in VSAccountProvider.TryAppendLocalParameter
            "&redirect_uri=" + encodeURIComponent(this.settings.redirectUri);
        // Get the authorization code. If this is the initial authentication
        // (the user is unknown), do not silently prompt. If this is a subsequent
        // authentication for an additional tenant, the browser cookie cache will
        // be used to authenticate without prompting, so run the browser silently.
        return this.getAuthorizationCode(authorizeUrl, this.settings.redirectUri, silent).then(function (capturedUrl) {
            if (!capturedUrl) {
                return Q.reject(new Error("Operation was canceled."));
            }
            var query = URI.parseQuery(URI.parse(capturedUrl).query), code = query.code;
            if (!code) {
                return Q.reject(new Error(query.error + ": " + query.error_description));
            }
            return q_1.Promise(function (resolve, reject) {
                var context = new adal.AuthenticationContext(authorityUrl, null, _this.tokenCache);
                context.acquireTokenWithAuthorizationCode(code, _this.settings.redirectUri, _this.settings.signInResourceId, _this.settings.clientId, null, function (error, response) {
                    if (error) {
                        reject(error);
                    }
                    else {
                        resolve(response);
                    }
                });
            });
        });
    };
    return Provider;
}(provider_base_1.default));
exports.default = Provider;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mbG93L2F1dGhvcml6YXRpb25Db2RlR3JhbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OzhEQUU4RDtBQUU5RCxZQUFZLENBQUM7Ozs7Ozs7Ozs7OztBQUViLDhCQUFnQztBQUNoQyxnQ0FBa0M7QUFDbEMsdUJBQTRCO0FBQzVCLHFCQUF1QjtBQUN2QiwyQkFBNkI7QUFFN0IsZ0NBQWtDO0FBQ2xDLGtEQUE0QztBQUU1Qyx5RUFBeUU7QUFDekUsMkVBQTJFO0FBQzNFLHNFQUFzRTtBQUN0RSwwREFBNEQ7QUFDNUQsSUFBSSxxQ0FBcUMsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLDZCQUE2QixDQUFDO0FBQ2pHLFlBQVksQ0FBQyxTQUFTLENBQUMsNkJBQTZCLEdBQUcsVUFDbkQsaUJBQXlCLEVBQUUsWUFBb0IsRUFBRSxRQUFtQztJQURqQyxpQkFjdEQ7SUFaRyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzlDLHFDQUFxQyxDQUFDLElBQUksQ0FDdEMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFDckMsVUFBQyxLQUFZLEVBQUUsUUFBK0M7UUFDMUQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNSLFFBQVEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDOUIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osS0FBSSxDQUFDLE9BQU8sR0FBeUIsUUFBUyxDQUFDLE1BQU0sQ0FBQztZQUN0RCxLQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsY0FBTSxPQUFBLFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLEVBQXhCLENBQXdCLENBQUMsQ0FBQztRQUNwRSxDQUFDO0lBQ0wsQ0FBQyxDQUNKLENBQUM7QUFDTixDQUFDLENBQUM7QUFFRjtJQUFzQyw0QkFBc0Q7SUFHeEYsa0JBQ0ksb0JBQXFELEVBQ3JE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LEtBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxVQUFDLEtBQUssRUFBRSxRQUFRO29CQUMxQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO3dCQUNSLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDbEIsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDSixPQUFPLENBQXNCLFFBQVEsQ0FBQyxDQUFDO29CQUMzQyxDQUFDO2dCQUNMLENBQUMsQ0FDSixDQUFDO1lBQ04sQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDTCxlQUFDO0FBQUQsQ0E5REEsQUE4REMsQ0E5RHFDLHVCQUFZLEdBOERqRCIsImZpbGUiOiJmbG93L2F1dGhvcml6YXRpb25Db2RlR3JhbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiEtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogQ29weXJpZ2h0IChDKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbmltcG9ydCAqIGFzIF8gZnJvbSBcInVuZGVyc2NvcmVcIjtcclxuaW1wb3J0ICogYXMgYWRhbCBmcm9tIFwiYWRhbC1ub2RlXCI7XHJcbmltcG9ydCB7IFByb21pc2UgfSBmcm9tIFwicVwiO1xyXG5pbXBvcnQgKiBhcyBRIGZyb20gXCJxXCI7XHJcbmltcG9ydCAqIGFzIFVSSSBmcm9tIFwidXJpanNcIjtcclxuXHJcbmltcG9ydCAqIGFzIGluZGV4IGZyb20gXCIuLi9pbmRleFwiO1xyXG5pbXBvcnQgUHJvdmlkZXJCYXNlIGZyb20gXCIuLi9wcm92aWRlci1iYXNlXCI7XHJcblxyXG4vLyBNb25rZXkgcGF0Y2ggdGhlIEFEQUwgVG9rZW5SZXF1ZXN0IGNsYXNzIHRvIGZpeCB0aGUgZmFjdCB0aGF0IHdoZW4geW91XHJcbi8vIHJlcXVlc3QgYSB0b2tlbiBmcm9tIGFuIGF1dGhvcml6YXRpb24gY29kZSwgaXQgZG9lc24ndCB1cGRhdGUgdGhlIGNhY2hlLlxyXG4vLyBUT0RPOiBnZXQgdGhpcyBjaGFuZ2UgcHVzaGVkIGludG8gdGhlIGFjdHVhbCBBREFMIGxpYnJhcnkgZm9yIE5vZGUuXHJcbmltcG9ydCAqIGFzIFRva2VuUmVxdWVzdCBmcm9tIFwiYWRhbC1ub2RlL2xpYi90b2tlbi1yZXF1ZXN0XCI7XHJcbmxldCBnZXRUb2tlbldpdGhBdXRob3JpemF0aW9uQ29kZU9yaWdpbmFsID0gVG9rZW5SZXF1ZXN0LnByb3RvdHlwZS5nZXRUb2tlbldpdGhBdXRob3JpemF0aW9uQ29kZTtcclxuVG9rZW5SZXF1ZXN0LnByb3RvdHlwZS5nZXRUb2tlbldpdGhBdXRob3JpemF0aW9uQ29kZSA9IGZ1bmN0aW9uIChcclxuICAgIGF1dGhvcml6YXRpb25Db2RlOiBzdHJpbmcsIGNsaWVudFNlY3JldDogc3RyaW5nLCBjYWxsYmFjazogYWRhbC5BY3F1aXJlVG9rZW5DYWxsYmFjaykge1xyXG4gICAgdGhpcy5fY2FjaGVEcml2ZXIgPSB0aGlzLl9jcmVhdGVDYWNoZURyaXZlcigpO1xyXG4gICAgZ2V0VG9rZW5XaXRoQXV0aG9yaXphdGlvbkNvZGVPcmlnaW5hbC5jYWxsKFxyXG4gICAgICAgIHRoaXMsIGF1dGhvcml6YXRpb25Db2RlLCBjbGllbnRTZWNyZXQsXHJcbiAgICAgICAgKGVycm9yOiBFcnJvciwgcmVzcG9uc2U6IGFkYWwuRXJyb3JSZXNwb25zZXxhZGFsLlRva2VuUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvciwgcmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fdXNlcklkID0gKDxhZGFsLlRva2VuUmVzcG9uc2U+IHJlc3BvbnNlKS51c2VySWQ7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jYWNoZURyaXZlci5hZGQocmVzcG9uc2UsICgpID0+IGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICApO1xyXG59O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUHJvdmlkZXIgZXh0ZW5kcyBQcm92aWRlckJhc2U8aW5kZXguQXV0aG9yaXphdGlvbkNvZGVHcmFudEZsb3dTZXR0aW5ncz4ge1xyXG4gICAgcHJpdmF0ZSBnZXRBdXRob3JpemF0aW9uQ29kZTogaW5kZXguQXV0aG9yaXphdGlvbkNvZGVDYWxsYmFjaztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBnZXRBdXRob3JpemF0aW9uQ29kZTogaW5kZXguQXV0aG9yaXphdGlvbkNvZGVDYWxsYmFjayxcclxuICAgICAgICBzZXR0aW5ncz86IGluZGV4LkF1dGhvcml6YXRpb25Db2RlR3JhbnRGbG93U2V0dGluZ3MsXHJcbiAgICAgICAgdG9rZW5DYWNoZT86IGFkYWwuVG9rZW5DYWNoZSkge1xyXG4gICAgICAgIHN1cGVyKF8uZXh0ZW5kKHt9LCBpbmRleC5kZWZhdWx0QXV0aG9yaXphdGlvbkNvZGVHcmFudEZsb3dTZXR0aW5ncywgc2V0dGluZ3MpLCB0b2tlbkNhY2hlKTtcclxuICAgICAgICB0aGlzLmdldEF1dGhvcml6YXRpb25Db2RlID0gZ2V0QXV0aG9yaXphdGlvbkNvZGU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGF1dGhlbnRpY2F0ZSh0ZW5hbnRJZDogc3RyaW5nLCBtc2E6IGJvb2xlYW4sIHVzZXJJZDogc3RyaW5nLCBzaWxlbnQ6IGJvb2xlYW4pIHtcclxuICAgICAgICBsZXQgYXV0aG9yaXR5VXJsID0gdGhpcy5zZXR0aW5ncy5ob3N0ICsgXCIvXCIgKyB0ZW5hbnRJZCxcclxuICAgICAgICAgICAgYXV0aG9yaXplVXJsID0gYXV0aG9yaXR5VXJsICsgXCIvb2F1dGgyL2F1dGhvcml6ZVwiICtcclxuICAgICAgICAgICAgICAgIC8vIFNwZWNpZnkgdGhlIGNsaWVudCBJRCwgcmVxdWVzdCB0aGUgYXV0aG9yaXphdGlvbiBjb2RlIGdyYW50IGZsb3dcclxuICAgICAgICAgICAgICAgIFwiP2NsaWVudF9pZD1cIiArIHRoaXMuc2V0dGluZ3MuY2xpZW50SWQgKyBcIiZyZXNwb25zZV90eXBlPWNvZGVcIiArXHJcbiAgICAgICAgICAgICAgICAvLyBTcGVjaWZ5IHNldHRpbmdzIHRvIG9wdGltaXplIHByb21wdCBnaXZlbiBleGlzdGluZyBNU0Egb3IgT3JnIElEXHJcbiAgICAgICAgICAgICAgICAodXNlcklkID8gKG1zYSA/IFwiJmRvbWFpbl9oaW50PWxpdmUuY29tXCIgOiBcIiZtc2FmZWQ9MFwiKSA6IFwiXCIpICtcclxuICAgICAgICAgICAgICAgIC8vIFNwZWNpZnkgc2V0dGluZ3MgdG8gcmVxdWlyZSBsb2dpbiBhbmQvb3IgcHJvdmlkZSBleGlzdGluZyB1c2VyIGFzIGEgaGludFxyXG4gICAgICAgICAgICAgICAgKCghdXNlcklkIHx8ICFzaWxlbnQpID8gXCImcHJvbXB0PWxvZ2luXCIgOiBcIlwiKSArXHJcbiAgICAgICAgICAgICAgICAodXNlcklkID8gKFwiJmxvZ2luX2hpbnQ9XCIgKyBlbmNvZGVVUklDb21wb25lbnQodXNlcklkKSkgOiBcIlwiKSArXHJcbiAgICAgICAgICAgICAgICAvLyBUaGUgc2l0ZSBJRCBjYW4gYmUgdXNlZCB0byBicmFuZCB0aGUgcHJvbXB0IGluIHNvbWUgZm9ybVxyXG4gICAgICAgICAgICAgICAgKHRoaXMuc2V0dGluZ3Muc2l0ZUlkID8gKFwiJnNpdGVfaWQ9XCIgKyB0aGlzLnNldHRpbmdzLnNpdGVJZCkgOiBcIlwiKSArXHJcbiAgICAgICAgICAgICAgICAvLyBUaGUgZGlzcGxheT1wb3B1cCBzZXR0aW5nIGNhdXNlcyBhIHBvcHVwIHZlcnNpb24gb2YgdGhlIFVJIHRvIGJlIHNob3duXHJcbiAgICAgICAgICAgICAgICBcIiZkaXNwbGF5PXBvcHVwXCIgK1xyXG4gICAgICAgICAgICAgICAgLy8gTm90IHN1cmUgd2hhdCB0aGUgbnV4PTEgc2V0dGluZyBkb2VzLCBidXQgaXQgd2FzIGluIHRoZSBWUyBrZXljaGFpblxyXG4gICAgICAgICAgICAgICAgXCImbnV4PTFcIiArXHJcbiAgICAgICAgICAgICAgICAvLyBTcGVjaWZ5IHRoZSByZXNvdXJjZSBmb3Igd2hpY2ggYW4gYWNjZXNzIHRva2VuIHNob3VsZCBiZSByZXRyaWV2ZWRcclxuICAgICAgICAgICAgICAgIFwiJnJlc291cmNlPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuc2V0dGluZ3Muc2lnbkluUmVzb3VyY2VJZCkgK1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogYWRkIGxvY2FsZSBwYXJhbWV0ZXIgbGlrZSBpbiBWU0FjY291bnRQcm92aWRlci5UcnlBcHBlbmRMb2NhbFBhcmFtZXRlclxyXG4gICAgICAgICAgICAgICAgXCImcmVkaXJlY3RfdXJpPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuc2V0dGluZ3MucmVkaXJlY3RVcmkpO1xyXG5cclxuICAgICAgICAvLyBHZXQgdGhlIGF1dGhvcml6YXRpb24gY29kZS4gSWYgdGhpcyBpcyB0aGUgaW5pdGlhbCBhdXRoZW50aWNhdGlvblxyXG4gICAgICAgIC8vICh0aGUgdXNlciBpcyB1bmtub3duKSwgZG8gbm90IHNpbGVudGx5IHByb21wdC4gSWYgdGhpcyBpcyBhIHN1YnNlcXVlbnRcclxuICAgICAgICAvLyBhdXRoZW50aWNhdGlvbiBmb3IgYW4gYWRkaXRpb25hbCB0ZW5hbnQsIHRoZSBicm93c2VyIGNvb2tpZSBjYWNoZSB3aWxsXHJcbiAgICAgICAgLy8gYmUgdXNlZCB0byBhdXRoZW50aWNhdGUgd2l0aG91dCBwcm9tcHRpbmcsIHNvIHJ1biB0aGUgYnJvd3NlciBzaWxlbnRseS5cclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRBdXRob3JpemF0aW9uQ29kZShhdXRob3JpemVVcmwsIHRoaXMuc2V0dGluZ3MucmVkaXJlY3RVcmksIHNpbGVudCkudGhlbihjYXB0dXJlZFVybCA9PiB7XHJcbiAgICAgICAgICAgIGlmICghY2FwdHVyZWRVcmwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBRLnJlamVjdDxhZGFsLlRva2VuUmVzcG9uc2U+KG5ldyBFcnJvcihcIk9wZXJhdGlvbiB3YXMgY2FuY2VsZWQuXCIpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcXVlcnk6IGFueSA9IFVSSS5wYXJzZVF1ZXJ5KFVSSS5wYXJzZShjYXB0dXJlZFVybCkucXVlcnkpLFxyXG4gICAgICAgICAgICAgICAgY29kZSA9IHF1ZXJ5LmNvZGU7XHJcbiAgICAgICAgICAgIGlmICghY29kZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFEucmVqZWN0PGFkYWwuVG9rZW5SZXNwb25zZT4obmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5LmVycm9yICsgXCI6IFwiICsgcXVlcnkuZXJyb3JfZGVzY3JpcHRpb24pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZTxhZGFsLlRva2VuUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBjb250ZXh0ID0gbmV3IGFkYWwuQXV0aGVudGljYXRpb25Db250ZXh0KGF1dGhvcml0eVVybCwgbnVsbCwgdGhpcy50b2tlbkNhY2hlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb250ZXh0LmFjcXVpcmVUb2tlbldpdGhBdXRob3JpemF0aW9uQ29kZShcclxuICAgICAgICAgICAgICAgICAgICBjb2RlLCB0aGlzLnNldHRpbmdzLnJlZGlyZWN0VXJpLCB0aGlzLnNldHRpbmdzLnNpZ25JblJlc291cmNlSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5jbGllbnRJZCwgbnVsbCwgKGVycm9yLCByZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKDxhZGFsLlRva2VuUmVzcG9uc2U+IHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
