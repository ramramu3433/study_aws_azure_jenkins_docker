/*!---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *----------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var _ = require("underscore");
var keytar = require("keytar");
var crypto = require("crypto");
var core = require("./core");
var jsonFile_1 = require("./jsonFile");
function getServiceKey(entry) {
    return entry._authority;
}
function getAccountKey(entry) {
    return entry.userId +
        "?clientId=" + entry._clientId +
        "&resource=" + entry.resource;
}
function getTokenPasswordKey(entry) {
    return getAccountKey(entry) + "&pwd=1";
}
function generateRandomBase64String(length) {
    return crypto.randomBytes(Math.ceil(3 / 4 * length)).toString("base64");
}
function encryptText(text, password) {
    if (!text) {
        return "";
    }
    var cipher = crypto.createCipher("aes-256-cbc", password);
    var crypted = cipher.update(text, "utf8", "base64");
    crypted += cipher.final("base64");
    return crypted;
}
function decryptText(text, password) {
    if (!text) {
        return "";
    }
    var decipher = crypto.createDecipher("aes-256-cbc", password);
    var decrypted = decipher.update(text, "base64", "utf8");
    decrypted += decipher.final("utf8");
    return decrypted;
}
var loadAndIncludeTokens, extractAndSaveTokens, deleteTokens;
loadAndIncludeTokens = function (entry) {
    var entryWithEncryption = entry;
    var password = keytar.getPassword(getServiceKey(entry), getTokenPasswordKey(entry));
    if (password && entryWithEncryption.encryptedRefreshToken && entryWithEncryption.encryptedAccessToken) {
        // First attempt the new encryption method which uses a securely stored (keytar) password to encrypt/decrypt the tokens.
        try {
            entry = _.extend(entry, {
                refreshToken: decryptText(entryWithEncryption.encryptedRefreshToken, password),
                accessToken: decryptText(entryWithEncryption.encryptedAccessToken, password)
            });
            entry = _.omit(entry, ["encryptedRefreshToken", "encryptedAccessToken"]);
        }
        catch (e) {
            // Failed to decrypt token value.
        }
    }
    else {
        // If no password and encrypted token properties found, fallback to the old way...
        // So data written by older versions of this module can still be read, and users don't have to re-enter credentials
        // for all accounts after upgrading to the new version of the module. Once the entries are written back to the cache,
        // it will always be in the new encryption format.
        var tokens = keytar.getPassword(getServiceKey(entry), getAccountKey(entry));
        if (tokens) {
            try {
                entry = _.extend(entry, JSON.parse(tokens));
            }
            catch (e) {
                // Tokens were not valid JSON
            }
        }
    }
    if (!entry.refreshToken || !entry.accessToken) {
        return null;
    }
    return entry;
};
extractAndSaveTokens = function (entry) {
    var password = keytar.getPassword(getServiceKey(entry), getTokenPasswordKey(entry));
    if (!password) {
        password = generateRandomBase64String(128);
        keytar.replacePassword(getServiceKey(entry), getTokenPasswordKey(entry), password);
    }
    var encryptedTokens = {
        encryptedRefreshToken: encryptText(entry.refreshToken, password),
        encryptedAccessToken: encryptText(entry.accessToken, password)
    };
    entry = _.omit(entry, ["refreshToken", "accessToken"]);
    entry = _.extend(entry, encryptedTokens);
    return entry;
};
deleteTokens = function (entry) {
    keytar.deletePassword(getServiceKey(entry), getTokenPasswordKey(entry));
};
var JsonFileWithNativeTokenCache = (function (_super) {
    __extends(JsonFileWithNativeTokenCache, _super);
    function JsonFileWithNativeTokenCache(filename) {
        // Since there is one native keychain per user (at least as implemented
        // by keytar), the file storing the other information should have the
        // same multiplicity, i.e. a single file in the user's home directory.
        return _super.call(this, null, filename || ".adalcache", true) || this;
    }
    JsonFileWithNativeTokenCache.prototype.findInCache = function (cache, query) {
        // Find entries from the cache
        var entries = core.find(cache, query);
        // Include the tokens for matching results
        entries = entries.map(loadAndIncludeTokens);
        // Remove any entries that were missing tokens
        entries = _.compact(entries);
        return entries;
    };
    JsonFileWithNativeTokenCache.prototype.addToCache = function (cache, entries) {
        // Extract and save tokens for the new entries
        entries = entries.map(extractAndSaveTokens);
        // Merge the new entries with the cache
        cache = core.add(cache, entries);
        return cache;
    };
    JsonFileWithNativeTokenCache.prototype.removeFromCache = function (cache, entries) {
        // Delete tokens for the specified entries
        entries.map(deleteTokens);
        // Remove the entries from the cache
        cache = core.remove(cache, entries);
        return cache;
    };
    return JsonFileWithNativeTokenCache;
}(jsonFile_1.default));
exports.default = JsonFileWithNativeTokenCache;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90b2tlbi1jYWNoZS9qc29uRmlsZVdpdGhOYXRpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OzhEQUU4RDtBQUU5RCxZQUFZLENBQUM7Ozs7Ozs7Ozs7OztBQUViLDhCQUFnQztBQUVoQywrQkFBaUM7QUFDakMsK0JBQWlDO0FBQ2pDLDZCQUErQjtBQUMvQix1Q0FBNEM7QUFFNUMsdUJBQXVCLEtBQTJCO0lBQzlDLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDO0FBQzVCLENBQUM7QUFFRCx1QkFBdUIsS0FBMkI7SUFDOUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNO1FBQ2YsWUFBWSxHQUFHLEtBQUssQ0FBQyxTQUFTO1FBQzlCLFlBQVksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO0FBQ3RDLENBQUM7QUFFRCw2QkFBNkIsS0FBMkI7SUFDcEQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxRQUFRLENBQUM7QUFDM0MsQ0FBQztBQUVELG9DQUFvQyxNQUFjO0lBQzlDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM1RSxDQUFDO0FBRUQscUJBQXFCLElBQVksRUFBRSxRQUFnQjtJQUMvQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDUixNQUFNLENBQUMsRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzFELElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNwRCxPQUFPLElBQUksTUFBTSxDQUFDLEtBQUssQ0FB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LENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUU1Qyw4Q0FBOEM7UUFDOUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFN0IsTUFBTSxDQUFDLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRVMsaURBQVUsR0FBcEIsVUFBcUIsS0FBNkIsRUFBRSxPQUErQjtRQUMvRSw4Q0FBOEM7UUFDOUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUU1Qyx1Q0FBdUM7UUFDdkMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRWpDLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVTLHNEQUFlLEdBQXpCLFVBQTBCLEtBQTZCLEVBQUUsT0FBK0I7UUFDcEYsMENBQTBDO1FBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFMUIsb0NBQW9DO1FBQ3BDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUVwQyxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFDTCxtQ0FBQztBQUFELENBeENBLEFBd0NDLENBeEN5RCxrQkFBa0IsR0F3QzNFIiwiZmlsZSI6InRva2VuLWNhY2hlL2pzb25GaWxlV2l0aE5hdGl2ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiBDb3B5cmlnaHQgKEMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuaW1wb3J0ICogYXMgXyBmcm9tIFwidW5kZXJzY29yZVwiO1xyXG5pbXBvcnQgKiBhcyBhZGFsIGZyb20gXCJhZGFsLW5vZGVcIjtcclxuaW1wb3J0ICogYXMga2V5dGFyIGZyb20gXCJrZXl0YXJcIjtcclxuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcclxuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi9jb3JlXCI7XHJcbmltcG9ydCBKc29uRmlsZVRva2VuQ2FjaGUgZnJvbSBcIi4vanNvbkZpbGVcIjtcclxuXHJcbmZ1bmN0aW9uIGdldFNlcnZpY2VLZXkoZW50cnk6IGFkYWwuVG9rZW5DYWNoZUVudHJ5KTogc3RyaW5nIHtcclxuICAgIHJldHVybiBlbnRyeS5fYXV0aG9yaXR5O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRBY2NvdW50S2V5KGVudHJ5OiBhZGFsLlRva2VuQ2FjaGVFbnRyeSk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gZW50cnkudXNlcklkICtcclxuICAgICAgICBcIj9jbGllbnRJZD1cIiArIGVudHJ5Ll9jbGllbnRJZCArXHJcbiAgICAgICAgXCImcmVzb3VyY2U9XCIgKyBlbnRyeS5yZXNvdXJjZTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0VG9rZW5QYXNzd29yZEtleShlbnRyeTogYWRhbC5Ub2tlbkNhY2hlRW50cnkpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGdldEFjY291bnRLZXkoZW50cnkpICsgXCImcHdkPTFcIjtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21CYXNlNjRTdHJpbmcobGVuZ3RoOiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGNyeXB0by5yYW5kb21CeXRlcyhNYXRoLmNlaWwoMyAvIDQgKiBsZW5ndGgpKS50b1N0cmluZyhcImJhc2U2NFwiKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZW5jcnlwdFRleHQodGV4dDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmICghdGV4dCkge1xyXG4gICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjaXBoZXIgPSBjcnlwdG8uY3JlYXRlQ2lwaGVyKFwiYWVzLTI1Ni1jYmNcIiwgcGFzc3dvcmQpO1xyXG4gICAgbGV0IGNyeXB0ZWQgPSBjaXBoZXIudXBkYXRlKHRleHQsIFwidXRmOFwiLCBcImJhc2U2NFwiKTtcclxuICAgIGNyeXB0ZWQgKz0gY2lwaGVyLmZpbmFsKFwiYmFzZTY0XCIpO1xyXG4gICAgcmV0dXJuIGNyeXB0ZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlY3J5cHRUZXh0KHRleHQ6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoIXRleHQpIHtcclxuICAgICAgICByZXR1cm4gXCJcIjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZGVjaXBoZXIgPSBjcnlwdG8uY3JlYXRlRGVjaXBoZXIoXCJhZXMtMjU2LWNiY1wiLCBwYXNzd29yZCk7XHJcbiAgICBsZXQgZGVjcnlwdGVkID0gZGVjaXBoZXIudXBkYXRlKHRleHQsIFwiYmFzZTY0XCIsIFwidXRmOFwiKTtcclxuICAgIGRlY3J5cHRlZCArPSBkZWNpcGhlci5maW5hbChcInV0ZjhcIik7XHJcbiAgICByZXR1cm4gZGVjcnlwdGVkO1xyXG59XHJcblxyXG5sZXQgbG9hZEFuZEluY2x1ZGVUb2tlbnM6IChlbnRyeTogYWRhbC5Ub2tlbkNhY2hlRW50cnkpID0+IGFkYWwuVG9rZW5DYWNoZUVudHJ5LFxyXG4gICAgZXh0cmFjdEFuZFNhdmVUb2tlbnM6IChlbnRyeTogYWRhbC5Ub2tlbkNhY2hlRW50cnkpID0+IGFkYWwuVG9rZW5DYWNoZUVudHJ5LFxyXG4gICAgZGVsZXRlVG9rZW5zOiAoZW50cnk6IGFkYWwuVG9rZW5DYWNoZUVudHJ5KSA9PiB2b2lkO1xyXG5cclxubG9hZEFuZEluY2x1ZGVUb2tlbnMgPSBlbnRyeSA9PiB7XHJcbiAgICBsZXQgZW50cnlXaXRoRW5jcnlwdGlvbjogYW55ID0gZW50cnk7XHJcbiAgICBsZXQgcGFzc3dvcmQ6IHN0cmluZyA9IGtleXRhci5nZXRQYXNzd29yZChnZXRTZXJ2aWNlS2V5KGVudHJ5KSwgZ2V0VG9rZW5QYXNzd29yZEtleShlbnRyeSkpO1xyXG4gICAgaWYgKHBhc3N3b3JkICYmIGVudHJ5V2l0aEVuY3J5cHRpb24uZW5jcnlwdGVkUmVmcmVzaFRva2VuICYmIGVudHJ5V2l0aEVuY3J5cHRpb24uZW5jcnlwdGVkQWNjZXNzVG9rZW4pIHtcclxuICAgICAgICAvLyBGaXJzdCBhdHRlbXB0IHRoZSBuZXcgZW5jcnlwdGlvbiBtZXRob2Qgd2hpY2ggdXNlcyBhIHNlY3VyZWx5IHN0b3JlZCAoa2V5dGFyKSBwYXNzd29yZCB0byBlbmNyeXB0L2RlY3J5cHQgdGhlIHRva2Vucy5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBlbnRyeSA9IF8uZXh0ZW5kKGVudHJ5LCB7XHJcbiAgICAgICAgICAgICAgICByZWZyZXNoVG9rZW46IGRlY3J5cHRUZXh0KGVudHJ5V2l0aEVuY3J5cHRpb24uZW5jcnlwdGVkUmVmcmVzaFRva2VuLCBwYXNzd29yZCksXHJcbiAgICAgICAgICAgICAgICBhY2Nlc3NUb2tlbjogZGVjcnlwdFRleHQoZW50cnlXaXRoRW5jcnlwdGlvbi5lbmNyeXB0ZWRBY2Nlc3NUb2tlbiwgcGFzc3dvcmQpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBlbnRyeSA9IF8ub21pdChlbnRyeSwgWyBcImVuY3J5cHRlZFJlZnJlc2hUb2tlblwiLCBcImVuY3J5cHRlZEFjY2Vzc1Rva2VuXCIgXSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAvLyBGYWlsZWQgdG8gZGVjcnlwdCB0b2tlbiB2YWx1ZS5cclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIElmIG5vIHBhc3N3b3JkIGFuZCBlbmNyeXB0ZWQgdG9rZW4gcHJvcGVydGllcyBmb3VuZCwgZmFsbGJhY2sgdG8gdGhlIG9sZCB3YXkuLi5cclxuICAgICAgICAvLyBTbyBkYXRhIHdyaXR0ZW4gYnkgb2xkZXIgdmVyc2lvbnMgb2YgdGhpcyBtb2R1bGUgY2FuIHN0aWxsIGJlIHJlYWQsIGFuZCB1c2VycyBkb24ndCBoYXZlIHRvIHJlLWVudGVyIGNyZWRlbnRpYWxzXHJcbiAgICAgICAgLy8gZm9yIGFsbCBhY2NvdW50cyBhZnRlciB1cGdyYWRpbmcgdG8gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZSBtb2R1bGUuIE9uY2UgdGhlIGVudHJpZXMgYXJlIHdyaXR0ZW4gYmFjayB0byB0aGUgY2FjaGUsXHJcbiAgICAgICAgLy8gaXQgd2lsbCBhbHdheXMgYmUgaW4gdGhlIG5ldyBlbmNyeXB0aW9uIGZvcm1hdC5cclxuICAgICAgICBsZXQgdG9rZW5zID0ga2V5dGFyLmdldFBhc3N3b3JkKGdldFNlcnZpY2VLZXkoZW50cnkpLCBnZXRBY2NvdW50S2V5KGVudHJ5KSk7XHJcbiAgICAgICAgaWYgKHRva2Vucykge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgZW50cnkgPSBfLmV4dGVuZChlbnRyeSwgSlNPTi5wYXJzZSh0b2tlbnMpKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgLy8gVG9rZW5zIHdlcmUgbm90IHZhbGlkIEpTT05cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghZW50cnkucmVmcmVzaFRva2VuIHx8ICFlbnRyeS5hY2Nlc3NUb2tlbikge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVudHJ5O1xyXG59O1xyXG5leHRyYWN0QW5kU2F2ZVRva2VucyA9IGVudHJ5ID0+IHtcclxuICAgIGxldCBwYXNzd29yZDogc3RyaW5nID0ga2V5dGFyLmdldFBhc3N3b3JkKGdldFNlcnZpY2VLZXkoZW50cnkpLCBnZXRUb2tlblBhc3N3b3JkS2V5KGVudHJ5KSk7XHJcblxyXG4gICAgaWYgKCFwYXNzd29yZCkgeyAgICAvLyBJZiBubyBleGlzdGluZyBwYXNzd29yZCBmb3IgdGhpcyBlbnRyeSwgZ2VuZXJhdGUgb25lLlxyXG4gICAgICAgIHBhc3N3b3JkID0gZ2VuZXJhdGVSYW5kb21CYXNlNjRTdHJpbmcoMTI4KTtcclxuICAgICAgICBrZXl0YXIucmVwbGFjZVBhc3N3b3JkKGdldFNlcnZpY2VLZXkoZW50cnkpLCBnZXRUb2tlblBhc3N3b3JkS2V5KGVudHJ5KSwgcGFzc3dvcmQpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBlbmNyeXB0ZWRUb2tlbnMgPSB7XHJcbiAgICAgICAgZW5jcnlwdGVkUmVmcmVzaFRva2VuOiBlbmNyeXB0VGV4dChlbnRyeS5yZWZyZXNoVG9rZW4sIHBhc3N3b3JkKSxcclxuICAgICAgICBlbmNyeXB0ZWRBY2Nlc3NUb2tlbjogZW5jcnlwdFRleHQoZW50cnkuYWNjZXNzVG9rZW4sIHBhc3N3b3JkKVxyXG4gICAgfTtcclxuXHJcbiAgICBlbnRyeSA9IF8ub21pdChlbnRyeSwgWyBcInJlZnJlc2hUb2tlblwiLCBcImFjY2Vzc1Rva2VuXCIgXSk7XHJcbiAgICBlbnRyeSA9IF8uZXh0ZW5kKGVudHJ5LCBlbmNyeXB0ZWRUb2tlbnMpO1xyXG4gICAgcmV0dXJuIGVudHJ5O1xyXG59O1xyXG5kZWxldGVUb2tlbnMgPSBlbnRyeSA9PiB7XHJcbiAgICBrZXl0YXIuZGVsZXRlUGFzc3dvcmQoZ2V0U2VydmljZUtleShlbnRyeSksIGdldFRva2VuUGFzc3dvcmRLZXkoZW50cnkpKTtcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEpzb25GaWxlV2l0aE5hdGl2ZVRva2VuQ2FjaGUgZXh0ZW5kcyBKc29uRmlsZVRva2VuQ2FjaGUge1xyXG4gICAgY29uc3RydWN0b3IoZmlsZW5hbWU/OiBzdHJpbmcpIHtcclxuICAgICAgICAvLyBTaW5jZSB0aGVyZSBpcyBvbmUgbmF0aXZlIGtleWNoYWluIHBlciB1c2VyIChhdCBsZWFzdCBhcyBpbXBsZW1lbnRlZFxyXG4gICAgICAgIC8vIGJ5IGtleXRhciksIHRoZSBmaWxlIHN0b3JpbmcgdGhlIG90aGVyIGluZm9ybWF0aW9uIHNob3VsZCBoYXZlIHRoZVxyXG4gICAgICAgIC8vIHNhbWUgbXVsdGlwbGljaXR5LCBpLmUuIGEgc2luZ2xlIGZpbGUgaW4gdGhlIHVzZXIncyBob21lIGRpcmVjdG9yeS5cclxuICAgICAgICBzdXBlcihudWxsLCBmaWxlbmFtZSB8fCBcIi5hZGFsY2FjaGVcIiwgdHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGZpbmRJbkNhY2hlKGNhY2hlOiBhZGFsLlRva2VuQ2FjaGVFbnRyeVtdLCBxdWVyeTogYWRhbC5Ub2tlbkNhY2hlUXVlcnkpIHtcclxuICAgICAgICAvLyBGaW5kIGVudHJpZXMgZnJvbSB0aGUgY2FjaGVcclxuICAgICAgICBsZXQgZW50cmllcyA9IGNvcmUuZmluZChjYWNoZSwgcXVlcnkpO1xyXG5cclxuICAgICAgICAvLyBJbmNsdWRlIHRoZSB0b2tlbnMgZm9yIG1hdGNoaW5nIHJlc3VsdHNcclxuICAgICAgICBlbnRyaWVzID0gZW50cmllcy5tYXAobG9hZEFuZEluY2x1ZGVUb2tlbnMpO1xyXG5cclxuICAgICAgICAvLyBSZW1vdmUgYW55IGVudHJpZXMgdGhhdCB3ZXJlIG1pc3NpbmcgdG9rZW5zXHJcbiAgICAgICAgZW50cmllcyA9IF8uY29tcGFjdChlbnRyaWVzKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGVudHJpZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGFkZFRvQ2FjaGUoY2FjaGU6IGFkYWwuVG9rZW5DYWNoZUVudHJ5W10sIGVudHJpZXM6IGFkYWwuVG9rZW5DYWNoZUVudHJ5W10pIHtcclxuICAgICAgICAvLyBFeHRyYWN0IGFuZCBzYXZlIHRva2VucyBmb3IgdGhlIG5ldyBlbnRyaWVzXHJcbiAgICAgICAgZW50cmllcyA9IGVudHJpZXMubWFwKGV4dHJhY3RBbmRTYXZlVG9rZW5zKTtcclxuXHJcbiAgICAgICAgLy8gTWVyZ2UgdGhlIG5ldyBlbnRyaWVzIHdpdGggdGhlIGNhY2hlXHJcbiAgICAgICAgY2FjaGUgPSBjb3JlLmFkZChjYWNoZSwgZW50cmllcyk7XHJcblxyXG4gICAgICAgIHJldHVybiBjYWNoZTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVtb3ZlRnJvbUNhY2hlKGNhY2hlOiBhZGFsLlRva2VuQ2FjaGVFbnRyeVtdLCBlbnRyaWVzOiBhZGFsLlRva2VuQ2FjaGVFbnRyeVtdKSB7XHJcbiAgICAgICAgLy8gRGVsZXRlIHRva2VucyBmb3IgdGhlIHNwZWNpZmllZCBlbnRyaWVzXHJcbiAgICAgICAgZW50cmllcy5tYXAoZGVsZXRlVG9rZW5zKTtcclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBlbnRyaWVzIGZyb20gdGhlIGNhY2hlXHJcbiAgICAgICAgY2FjaGUgPSBjb3JlLnJlbW92ZShjYWNoZSwgZW50cmllcyk7XHJcblxyXG4gICAgICAgIHJldHVybiBjYWNoZTtcclxuICAgIH1cclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
