/*!---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *----------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var adal = require("adal-node");
var events_1 = require("events");
var q_1 = require("q");
var Q = require("q");
var request = require("request");
var index = require("./index");
// TODO: load the logos in a more appropriate manner
/* tslint:disable no-require-imports */
var logos = require("../res/logos.json");
/* tslint:enable */
var ProviderBase = (function (_super) {
    __extends(ProviderBase, _super);
    function ProviderBase(settings, tokenCache) {
        var _this = _super.call(this) || this;
        _this.id = index.id;
        _this.args = {
            host: settings.host,
            clientId: settings.clientId
        };
        _this.settings = settings;
        /* tslint:disable no-require-imports */
        _this.tokenCache = tokenCache || new (require("./token-cache/inMemory").default)();
        return _this;
        /* tslint:enable */
    }
    ProviderBase.prototype.getTenantIds = function (userId) {
        var _this = this;
        return q_1.Promise(function (resolve, reject) {
            // Get an access token to the ARM resource
            var authorityUrl = _this.settings.host + "/common", context = new adal.AuthenticationContext(authorityUrl, null, _this.tokenCache);
            context.acquireToken(_this.settings.armResource.id, userId, _this.settings.clientId, function (error, response) {
                if (error) {
                    reject(error);
                    return;
                }
                if (!!_this.settings.adTenants && _this.settings.adTenants.length > 0) {
                    resolve(_this.settings.adTenants);
                }
                else {
                    request.get(_this.settings.armResource.endpoint + "/tenants?api-version=2015-01-01", {
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + response.accessToken
                        },
                        json: true
                    }, function (armError, armResponse, body) {
                        if (armError || body.error) {
                            reject(armError || body.error);
                        }
                        else {
                            resolve(body.value.map(function (item) { return item.tenantId; }));
                        }
                    });
                }
            });
        });
    };
    ProviderBase.prototype.getTenantDisplayName = function (tenantId, userId) {
        var _this = this;
        return q_1.Promise(function (resolve, reject) {
            // Get an access token to the AAD Graph resource
            var authorityUrl = _this.settings.host + "/" + tenantId, context = new adal.AuthenticationContext(authorityUrl, null, _this.tokenCache);
            context.acquireToken(_this.settings.graphResource.id, userId, _this.settings.clientId, function (error, response) {
                if (error) {
                    reject(error);
                    return;
                }
                request.get(_this.settings.graphResource.endpoint + "/" + tenantId + "/tenantDetails?api-version=2013-04-05", {
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + response.accessToken
                    },
                    json: true
                }, function (graphError, graphResponse, body) {
                    if (graphError || body["odata.error"]) {
                        reject(graphError || body["odata.error"]);
                    }
                    else if (body.value.length && body.value[0].displayName) {
                        resolve(body.value[0].displayName);
                    }
                    else {
                        // TODO: localization
                        resolve("Work or school account");
                    }
                });
            });
        });
    };
    ProviderBase.prototype.getTenants = function (msa, userId, tenantIds) {
        var _this = this;
        var tenants = [], authenticateAgainstTenant = function (index) {
            if (index < tenantIds.length) {
                // Authenticate the next tenant
                return _this.authenticate(tenantIds[index], msa, userId, true).then(function (response) {
                    var getTenantName = msa ?
                        // TODO: localization
                        Q.resolve("Microsoft account") :
                        _this.getTenantDisplayName(response.tenantId, response.userId);
                    return getTenantName.then(function (displayName) {
                        tenants.push({
                            id: response.tenantId,
                            displayName: displayName,
                            userId: response.userId
                        });
                        return authenticateAgainstTenant(index + 1);
                    });
                });
            }
            else {
                // All tenants authenticated; return result
                return Q.resolve(tenants);
            }
        };
        return authenticateAgainstTenant(0);
    };
    ProviderBase.prototype.signIn = function (msa, userId) {
        var _this = this;
        // Initial authentication is via the common/discovery tenant
        return this.authenticate("common", msa, userId, false).then(function (response) {
            var identityProvider = response.identityProvider;
            if (identityProvider) {
                identityProvider = identityProvider.toLowerCase();
            }
            // Determine if this is a Microsoft account
            msa = identityProvider && (identityProvider.indexOf("live.com") !== -1 ||
                identityProvider.indexOf("live-int.com") !== -1 ||
                identityProvider.indexOf("f8cdef31-a31e-4b4a-93e4-5f571e91255a") !== -1 ||
                identityProvider.indexOf("ea8a4392-515e-481f-879e-6571ff2a8a36") !== -1);
            // Get the user information
            userId = response.userId;
            var displayName = (response.givenName && response.familyName) ?
                (response.givenName + " " + response.familyName) : userId;
            // Get all the additional tenants
            return _this.getTenantIds(userId).then(function (tenantIds) {
                // Ensure the home tenant ID is the first in the list
                var homeTenantIndex = tenantIds.indexOf(response.tenantId);
                if (homeTenantIndex >= 0) {
                    tenantIds.splice(homeTenantIndex, 1);
                }
                tenantIds.unshift(response.tenantId);
                // Now authenticate with each tenant and get tenant information
                return _this.getTenants(msa, userId, tenantIds);
            }).then(function (tenants) {
                return {
                    key: {
                        providerId: _this.id,
                        providerArgs: _this.args,
                        accountId: userId
                    },
                    name: userId,
                    displayInfo: {
                        // TODO: don't provide the logo this way
                        contextualLogo: msa ? logos.msa : logos.org,
                        contextualDisplayName: tenants[0].displayName,
                        displayName: displayName
                    },
                    properties: {
                        isMsAccount: msa,
                        tenants: tenants
                    },
                    stale: false
                };
            });
        });
    };
    ProviderBase.prototype.getSettings = function () {
        return Q.resolve(this.settings);
    };
    ProviderBase.prototype.prompt = function () {
        return this.signIn();
    };
    ProviderBase.prototype.refresh = function (account) {
        return this.signIn(account.properties.isMsAccount, account.name);
    };
    ProviderBase.prototype.clear = function (account) {
        var _this = this;
        return q_1.Promise(function (resolve, reject) { return _this.tokenCache.find({
            _authority: null,
            _clientId: _this.settings.clientId,
            userId: account.name
        }, function (error, entries) {
            if (error) {
                reject(error);
            }
            // Filter the entries to this provider's host, but still all tenants
            entries = entries.filter(function (entry) { return entry._authority.indexOf(_this.settings.host + "/") !== 0; });
            // Remove all the entries
            _this.tokenCache.remove(entries, function (removeError) {
                if (removeError) {
                    reject(removeError);
                    return;
                }
                // The account is clearly stale now
                _this.emit("stale", account);
                resolve(null);
            });
        }); });
    };
    ProviderBase.prototype.isMicrosoftAccount = function (account) {
        return Q.resolve(account.properties.isMsAccount);
    };
    ProviderBase.prototype.getHomeTenant = function (account) {
        return Q.resolve(account.properties.tenants[0]);
    };
    ProviderBase.prototype.getAllTenants = function (account) {
        return Q.resolve(account.properties.tenants);
    };
    ProviderBase.prototype.tryAcquireToken = function (account, tenantId, resourceId) {
        var _this = this;
        var authorityUrl = this.settings.host + "/" + tenantId, context = new adal.AuthenticationContext(authorityUrl, null, this.tokenCache), tenants = account.properties.tenants, userId;
        for (var i = 0; i < tenants.length; i++) {
            if (tenants[i].id === tenantId) {
                userId = tenants[i].userId;
                break;
            }
        }
        if (!userId) {
            return Q.reject(new Error("Unknown tenant."));
        }
        return q_1.Promise(function (resolve, reject) {
            context.acquireToken(resourceId, userId, _this.settings.clientId, function (error, response) {
                if (error) {
                    // TODO: for now, assume the reason for failure is always because
                    // tokens are expired or missing, so raise that the account is stale.
                    _this.emit("stale", account);
                    reject(error);
                }
                else {
                    resolve(response.accessToken);
                }
            });
        });
    };
    ProviderBase.prototype.listeners = function (event) {
        return _super.prototype.listeners.call(this, event);
    };
    return ProviderBase;
}(events_1.EventEmitter));
exports.default = ProviderBase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wcm92aWRlci1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs4REFFOEQ7QUFFOUQsWUFBWSxDQUFDOzs7Ozs7Ozs7Ozs7QUFFYixnQ0FBa0M7QUFDbEMsaUNBQXNDO0FBQ3RDLHVCQUE0QjtBQUM1QixxQkFBdUI7QUFDdkIsaUNBQW1DO0FBS25DLCtCQUFpQztBQU1qQyxvREFBb0Q7QUFDcEQsdUNBQXVDO0FBQ3ZDLElBQUksS0FBSyxHQUFpQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUN2RSxtQkFBbUI7QUFFbkI7SUFDWSxnQ0FBWTtJQU1wQixzQkFBWSxRQUFtQixFQUFFLFVBQTRCO1FBQTdELFlBQ0ksaUJBQU8sU0FTVjtRQWZNLFFBQUUsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBT2pCLEtBQUksQ0FBQyxJQUFJLEdBQUc7WUFDUixJQUFJLEVBQUUsUUFBUSxDQUFDLElBQUk7WUFDbkIsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRO1NBQzlCLENBQUM7UUFDRixLQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6Qix1Q0FBdUM7UUFDdkMsS0FBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7O1FBQ2xGLG1CQUFtQjtJQUN2QixDQUFDO0lBSU8sbUNBQVksR0FBcEIsVUFBcUIsTUFBYztRQUFuQyxpQkFrQ0M7UUFqQ0csTUFBTSxDQUFDLFdBQU8sQ0FBVyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ3JDLDBDQUEwQztZQUMxQyxJQUFJLFlBQVksR0FBRyxLQUFJLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxTQUFTLEVBQzdDLE9BQU8sR0FBRyxJQUFJLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLEVBQUUsSUFBSSxFQUFFLEtBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNsRixPQUFP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QUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7b0JBQzVCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbEIsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDSixPQUFPLENBQXNCLFFBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDeEQsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sZ0NBQVMsR0FBaEIsVUFBaUIsS0FBYztRQUMzQixNQUFNLENBQWlDLGlCQUFNLFNBQVMsWUFBQyxLQUFLLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBQ0wsbUJBQUM7QUFBRCxDQXBRQSxBQW9RQyxDQW5RVyxxQkFBWSxHQW1RdkI7QUFFRCxrQkFBZSxZQUFZLENBQUMiLCJmaWxlIjoicHJvdmlkZXItYmFzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiBDb3B5cmlnaHQgKEMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuaW1wb3J0ICogYXMgYWRhbCBmcm9tIFwiYWRhbC1ub2RlXCI7XHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcclxuaW1wb3J0IHsgUHJvbWlzZSB9IGZyb20gXCJxXCI7XHJcbmltcG9ydCAqIGFzIFEgZnJvbSBcInFcIjtcclxuaW1wb3J0ICogYXMgcmVxdWVzdCBmcm9tIFwicmVxdWVzdFwiO1xyXG5cclxuaW1wb3J0ICogYXMgaWRlbnRpdHkgZnJvbSBcIm1zaW50LWlkZW50aXR5XCI7XHJcbmltcG9ydCAqIGFzIG1hbmFnZXIgZnJvbSBcIm1zaW50LWlkZW50aXR5L2xpYi9tYW5hZ2VyXCI7XHJcblxyXG5pbXBvcnQgKiBhcyBpbmRleCBmcm9tIFwiLi9pbmRleFwiO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBY2NvdW50UHJvdmlkZXIgZXh0ZW5kcyBpbmRleC5BY2NvdW50UHJvdmlkZXIsIG1hbmFnZXIuQWNjb3VudFByb3ZpZGVyIHtcclxuICAgIGFyZ3M6IGFueTtcclxufVxyXG5cclxuLy8gVE9ETzogbG9hZCB0aGUgbG9nb3MgaW4gYSBtb3JlIGFwcHJvcHJpYXRlIG1hbm5lclxyXG4vKiB0c2xpbnQ6ZGlzYWJsZSBuby1yZXF1aXJlLWltcG9ydHMgKi9cclxubGV0IGxvZ29zOiB7IG1zYTogc3RyaW5nOyBvcmc6IHN0cmluZyB9ID0gcmVxdWlyZShcIi4uL3Jlcy9sb2dvcy5qc29uXCIpO1xyXG4vKiB0c2xpbnQ6ZW5hYmxlICovXHJcblxyXG5hYnN0cmFjdCBjbGFzcyBQcm92aWRlckJhc2U8VFNldHRpbmdzIGV4dGVuZHMgaW5kZXguU2V0dGluZ3M+XHJcbiAgICBleHRlbmRzIEV2ZW50RW1pdHRlciBpbXBsZW1lbnRzIGluZGV4LkFjY291bnRQcm92aWRlciwgbWFuYWdlci5BY2NvdW50UHJvdmlkZXIge1xyXG4gICAgcHVibGljIGlkID0gaW5kZXguaWQ7XHJcbiAgICBwdWJsaWMgYXJnczogaW5kZXguQXJndW1lbnRzO1xyXG4gICAgcHVibGljIHNldHRpbmdzOiBUU2V0dGluZ3M7XHJcbiAgICBwcm90ZWN0ZWQgdG9rZW5DYWNoZTogYWRhbC5Ub2tlbkNhY2hlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHNldHRpbmdzOiBUU2V0dGluZ3MsIHRva2VuQ2FjaGU/OiBhZGFsLlRva2VuQ2FjaGUpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuYXJncyA9IHtcclxuICAgICAgICAgICAgaG9zdDogc2V0dGluZ3MuaG9zdCxcclxuICAgICAgICAgICAgY2xpZW50SWQ6IHNldHRpbmdzLmNsaWVudElkXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3M7XHJcbiAgICAgICAgLyogdHNsaW50OmRpc2FibGUgbm8tcmVxdWlyZS1pbXBvcnRzICovXHJcbiAgICAgICAgdGhpcy50b2tlbkNhY2hlID0gdG9rZW5DYWNoZSB8fCBuZXcgKHJlcXVpcmUoXCIuL3Rva2VuLWNhY2hlL2luTWVtb3J5XCIpLmRlZmF1bHQpKCk7XHJcbiAgICAgICAgLyogdHNsaW50OmVuYWJsZSAqL1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBhdXRoZW50aWNhdGUodGVuYW50SWQ6IHN0cmluZywgbXNhOiBib29sZWFuLCB1c2VySWQ6IHN0cmluZywgc2lsZW50OiBib29sZWFuKTogUHJvbWlzZTxhZGFsLlRva2VuUmVzcG9uc2U+O1xyXG5cclxuICAgIHByaXZhdGUgZ2V0VGVuYW50SWRzKHVzZXJJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2U8c3RyaW5nW10+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgLy8gR2V0IGFuIGFjY2VzcyB0b2tlbiB0byB0aGUgQVJNIHJlc291cmNlXHJcbiAgICAgICAgICAgIGxldCBhdXRob3JpdHlVcmwgPSB0aGlzLnNldHRpbmdzLmhvc3QgKyBcIi9jb21tb25cIixcclxuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBuZXcgYWRhbC5BdXRoZW50aWNhdGlvbkNvbnRleHQoYXV0aG9yaXR5VXJsLCBudWxsLCB0aGlzLnRva2VuQ2FjaGUpO1xyXG4gICAgICAgICAgICBjb250ZXh0LmFjcXVpcmVUb2tlbih0aGlzLnNldHRpbmdzLmFybVJlc291cmNlLmlkLCB1c2VySWQsIHRoaXMuc2V0dGluZ3MuY2xpZW50SWQsIChlcnJvciwgcmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghIXRoaXMuc2V0dGluZ3MuYWRUZW5hbnRzICYmIHRoaXMuc2V0dGluZ3MuYWRUZW5hbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMuc2V0dGluZ3MuYWRUZW5hbnRzKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5nZXQoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MuYXJtUmVzb3VyY2UuZW5kcG9pbnQgKyBcIi90ZW5hbnRzP2FwaS12ZXJzaW9uPTIwMTUtMDEtMDFcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQXV0aG9yaXphdGlvblwiOiBcIkJlYXJlciBcIiArICg8YWRhbC5Ub2tlblJlc3BvbnNlPnJlc3BvbnNlKS5hY2Nlc3NUb2tlblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb246IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGFybUVycm9yLCBhcm1SZXNwb25zZSwgYm9keTogeyBlcnJvcjogYW55OyB2YWx1ZTogYW55W107IH0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcm1FcnJvciB8fCBib2R5LmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGFybUVycm9yIHx8IGJvZHkuZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGJvZHkudmFsdWUubWFwKGl0ZW0gPT4gPHN0cmluZz5pdGVtLnRlbmFudElkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFRlbmFudERpc3BsYXlOYW1lKHRlbmFudElkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIC8vIEdldCBhbiBhY2Nlc3MgdG9rZW4gdG8gdGhlIEFBRCBHcmFwaCByZXNvdXJjZVxyXG4gICAgICAgICAgICBsZXQgYXV0aG9yaXR5VXJsID0gdGhpcy5zZXR0aW5ncy5ob3N0ICsgXCIvXCIgKyB0ZW5hbnRJZCxcclxuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBuZXcgYWRhbC5BdXRoZW50aWNhdGlvbkNvbnRleHQoYXV0aG9yaXR5VXJsLCBudWxsLCB0aGlzLnRva2VuQ2FjaGUpO1xyXG4gICAgICAgICAgICBjb250ZXh0LmFjcXVpcmVUb2tlbih0aGlzLnNldHRpbmdzLmdyYXBoUmVzb3VyY2UuaWQsIHVzZXJJZCwgdGhpcy5zZXR0aW5ncy5jbGllbnRJZCwgKGVycm9yLCByZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmVxdWVzdC5nZXQoXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5ncmFwaFJlc291cmNlLmVuZHBvaW50ICsgXCIvXCIgKyB0ZW5hbnRJZCArIFwiL3RlbmFudERldGFpbHM/YXBpLXZlcnNpb249MjAxMy0wNC0wNVwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkF1dGhvcml6YXRpb25cIjogXCJCZWFyZXIgXCIgKyAoPGFkYWwuVG9rZW5SZXNwb25zZT5yZXNwb25zZSkuYWNjZXNzVG9rZW5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgKGdyYXBoRXJyb3IsIGdyYXBoUmVzcG9uc2UsIGJvZHk6IHsgZXJyb3I6IGFueTsgdmFsdWU6IGFueVtdOyB9KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFwaEVycm9yIHx8IGJvZHlbXCJvZGF0YS5lcnJvclwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGdyYXBoRXJyb3IgfHwgYm9keVtcIm9kYXRhLmVycm9yXCJdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChib2R5LnZhbHVlLmxlbmd0aCAmJiBib2R5LnZhbHVlWzBdLmRpc3BsYXlOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGJvZHkudmFsdWVbMF0uZGlzcGxheU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogbG9jYWxpemF0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKFwiV29yayBvciBzY2hvb2wgYWNjb3VudFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0VGVuYW50cyhtc2E6IGJvb2xlYW4sIHVzZXJJZDogc3RyaW5nLCB0ZW5hbnRJZHM6IHN0cmluZ1tdKSB7XHJcbiAgICAgICAgbGV0IHRlbmFudHM6IGluZGV4LlRlbmFudFtdID0gW10sXHJcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0ZUFnYWluc3RUZW5hbnQ6IChpbmRleDogbnVtYmVyKSA9PiBQcm9taXNlPGluZGV4LlRlbmFudFtdPiA9IGluZGV4ID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IHRlbmFudElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBBdXRoZW50aWNhdGUgdGhlIG5leHQgdGVuYW50XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRlKHRlbmFudElkc1tpbmRleF0sIG1zYSwgdXNlcklkLCB0cnVlKS50aGVuKHJlc3BvbnNlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGdldFRlbmFudE5hbWUgPSBtc2EgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogbG9jYWxpemF0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBRLnJlc29sdmUoXCJNaWNyb3NvZnQgYWNjb3VudFwiKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFRlbmFudERpc3BsYXlOYW1lKHJlc3BvbnNlLnRlbmFudElkLCByZXNwb25zZS51c2VySWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0VGVuYW50TmFtZS50aGVuKGRpc3BsYXlOYW1lID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbmFudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHJlc3BvbnNlLnRlbmFudElkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBkaXNwbGF5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IHJlc3BvbnNlLnVzZXJJZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXV0aGVudGljYXRlQWdhaW5zdFRlbmFudChpbmRleCArIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQWxsIHRlbmFudHMgYXV0aGVudGljYXRlZDsgcmV0dXJuIHJlc3VsdFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBRLnJlc29sdmUodGVuYW50cyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIGF1dGhlbnRpY2F0ZUFnYWluc3RUZW5hbnQoMCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzaWduSW4obXNhPzogYm9vbGVhbiwgdXNlcklkPzogc3RyaW5nKSB7XHJcbiAgICAgICAgLy8gSW5pdGlhbCBhdXRoZW50aWNhdGlvbiBpcyB2aWEgdGhlIGNvbW1vbi9kaXNjb3ZlcnkgdGVuYW50XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRlKFwiY29tbW9uXCIsIG1zYSwgdXNlcklkLCBmYWxzZSkudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBpZGVudGl0eVByb3ZpZGVyID0gcmVzcG9uc2UuaWRlbnRpdHlQcm92aWRlcjtcclxuICAgICAgICAgICAgaWYgKGlkZW50aXR5UHJvdmlkZXIpIHtcclxuICAgICAgICAgICAgICAgIGlkZW50aXR5UHJvdmlkZXIgPSBpZGVudGl0eVByb3ZpZGVyLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIERldGVybWluZSBpZiB0aGlzIGlzIGEgTWljcm9zb2Z0IGFjY291bnRcclxuICAgICAgICAgICAgbXNhID0gaWRlbnRpdHlQcm92aWRlciAmJiAoXHJcbiAgICAgICAgICAgICAgICBpZGVudGl0eVByb3ZpZGVyLmluZGV4T2YoXCJsaXZlLmNvbVwiKSAhPT0gLTEgfHxcclxuICAgICAgICAgICAgICAgIGlkZW50aXR5UHJvdmlkZXIuaW5kZXhPZihcImxpdmUtaW50LmNvbVwiKSAhPT0gLTEgfHxcclxuICAgICAgICAgICAgICAgIGlkZW50aXR5UHJvdmlkZXIuaW5kZXhPZihcImY4Y2RlZjMxLWEzMWUtNGI0YS05M2U0LTVmNTcxZTkxMjU1YVwiKSAhPT0gLTEgfHxcclxuICAgICAgICAgICAgICAgIGlkZW50aXR5UHJvdmlkZXIuaW5kZXhPZihcImVhOGE0MzkyLTUxNWUtNDgxZi04NzllLTY1NzFmZjJhOGEzNlwiKSAhPT0gLTEpO1xyXG5cclxuICAgICAgICAgICAgLy8gR2V0IHRoZSB1c2VyIGluZm9ybWF0aW9uXHJcbiAgICAgICAgICAgIHVzZXJJZCA9IHJlc3BvbnNlLnVzZXJJZDtcclxuICAgICAgICAgICAgbGV0IGRpc3BsYXlOYW1lID0gKHJlc3BvbnNlLmdpdmVuTmFtZSAmJiByZXNwb25zZS5mYW1pbHlOYW1lKSA/XHJcbiAgICAgICAgICAgICAgICAocmVzcG9uc2UuZ2l2ZW5OYW1lICsgXCIgXCIgKyByZXNwb25zZS5mYW1pbHlOYW1lKSA6IHVzZXJJZDtcclxuXHJcbiAgICAgICAgICAgIC8vIEdldCBhbGwgdGhlIGFkZGl0aW9uYWwgdGVuYW50c1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUZW5hbnRJZHModXNlcklkKS50aGVuKHRlbmFudElkcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhlIGhvbWUgdGVuYW50IElEIGlzIHRoZSBmaXJzdCBpbiB0aGUgbGlzdFxyXG4gICAgICAgICAgICAgICAgbGV0IGhvbWVUZW5hbnRJbmRleCA9IHRlbmFudElkcy5pbmRleE9mKHJlc3BvbnNlLnRlbmFudElkKTtcclxuICAgICAgICAgICAgICAgIGlmIChob21lVGVuYW50SW5kZXggPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRlbmFudElkcy5zcGxpY2UoaG9tZVRlbmFudEluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRlbmFudElkcy51bnNoaWZ0KHJlc3BvbnNlLnRlbmFudElkKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBOb3cgYXV0aGVudGljYXRlIHdpdGggZWFjaCB0ZW5hbnQgYW5kIGdldCB0ZW5hbnQgaW5mb3JtYXRpb25cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFRlbmFudHMobXNhLCB1c2VySWQsIHRlbmFudElkcyk7XHJcbiAgICAgICAgICAgIH0pLnRoZW4odGVuYW50cyA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gPGlkZW50aXR5LkFjY291bnQ+e1xyXG4gICAgICAgICAgICAgICAgICAgIGtleToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcklkOiB0aGlzLmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlckFyZ3M6IHRoaXMuYXJncyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudElkOiB1c2VySWRcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHVzZXJJZCxcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5SW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBkb24ndCBwcm92aWRlIHRoZSBsb2dvIHRoaXMgd2F5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHR1YWxMb2dvOiBtc2EgPyBsb2dvcy5tc2EgOiBsb2dvcy5vcmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHR1YWxEaXNwbGF5TmFtZTogdGVuYW50c1swXS5kaXNwbGF5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IGRpc3BsYXlOYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzTXNBY2NvdW50OiBtc2EsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbmFudHM6IHRlbmFudHNcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YWxlOiBmYWxzZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFNldHRpbmdzKCkge1xyXG4gICAgICAgIHJldHVybiBRLnJlc29sdmUodGhpcy5zZXR0aW5ncyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHByb21wdCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zaWduSW4oKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVmcmVzaChhY2NvdW50OiBpZGVudGl0eS5BY2NvdW50KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2lnbkluKGFjY291bnQucHJvcGVydGllcy5pc01zQWNjb3VudCwgYWNjb3VudC5uYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xlYXIoYWNjb3VudDogaWRlbnRpdHkuQWNjb3VudCkge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHRoaXMudG9rZW5DYWNoZS5maW5kKFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBfYXV0aG9yaXR5OiBudWxsLCAvLyBhbGwgaG9zdHMgYW5kIHRlbmFudHNcclxuICAgICAgICAgICAgICAgIF9jbGllbnRJZDogdGhpcy5zZXR0aW5ncy5jbGllbnRJZCxcclxuICAgICAgICAgICAgICAgIHVzZXJJZDogYWNjb3VudC5uYW1lXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIChlcnJvciwgZW50cmllcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyBGaWx0ZXIgdGhlIGVudHJpZXMgdG8gdGhpcyBwcm92aWRlcidzIGhvc3QsIGJ1dCBzdGlsbCBhbGwgdGVuYW50c1xyXG4gICAgICAgICAgICAgICAgZW50cmllcyA9IGVudHJpZXMuZmlsdGVyKGVudHJ5ID0+IGVudHJ5Ll9hdXRob3JpdHkuaW5kZXhPZih0aGlzLnNldHRpbmdzLmhvc3QgKyBcIi9cIikgIT09IDApO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhbGwgdGhlIGVudHJpZXNcclxuICAgICAgICAgICAgICAgIHRoaXMudG9rZW5DYWNoZS5yZW1vdmUoZW50cmllcywgcmVtb3ZlRXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QocmVtb3ZlRXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBUaGUgYWNjb3VudCBpcyBjbGVhcmx5IHN0YWxlIG5vd1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcInN0YWxlXCIsIGFjY291bnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaXNNaWNyb3NvZnRBY2NvdW50KGFjY291bnQ6IGlkZW50aXR5LkFjY291bnQpIHtcclxuICAgICAgICByZXR1cm4gUS5yZXNvbHZlPGJvb2xlYW4+KGFjY291bnQucHJvcGVydGllcy5pc01zQWNjb3VudCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEhvbWVUZW5hbnQoYWNjb3VudDogaWRlbnRpdHkuQWNjb3VudCkge1xyXG4gICAgICAgIHJldHVybiBRLnJlc29sdmU8aW5kZXguVGVuYW50PihhY2NvdW50LnByb3BlcnRpZXMudGVuYW50c1swXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEFsbFRlbmFudHMoYWNjb3VudDogaWRlbnRpdHkuQWNjb3VudCkge1xyXG4gICAgICAgIHJldHVybiBRLnJlc29sdmU8aW5kZXguVGVuYW50W10+KGFjY291bnQucHJvcGVydGllcy50ZW5hbnRzKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdHJ5QWNxdWlyZVRva2VuKGFjY291bnQ6IGlkZW50aXR5LkFjY291bnQsIHRlbmFudElkOiBzdHJpbmcsIHJlc291cmNlSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBhdXRob3JpdHlVcmwgPSB0aGlzLnNldHRpbmdzLmhvc3QgKyBcIi9cIiArIHRlbmFudElkLFxyXG4gICAgICAgICAgICBjb250ZXh0ID0gbmV3IGFkYWwuQXV0aGVudGljYXRpb25Db250ZXh0KGF1dGhvcml0eVVybCwgbnVsbCwgdGhpcy50b2tlbkNhY2hlKSxcclxuICAgICAgICAgICAgdGVuYW50czogaW5kZXguVGVuYW50W10gPSBhY2NvdW50LnByb3BlcnRpZXMudGVuYW50cyxcclxuICAgICAgICAgICAgdXNlcklkOiBzdHJpbmc7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZW5hbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh0ZW5hbnRzW2ldLmlkID09PSB0ZW5hbnRJZCkge1xyXG4gICAgICAgICAgICAgICAgdXNlcklkID0gdGVuYW50c1tpXS51c2VySWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXVzZXJJZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gUS5yZWplY3Q8c3RyaW5nPihuZXcgRXJyb3IoXCJVbmtub3duIHRlbmFudC5cIikpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29udGV4dC5hY3F1aXJlVG9rZW4ocmVzb3VyY2VJZCwgdXNlcklkLCB0aGlzLnNldHRpbmdzLmNsaWVudElkLCAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBmb3Igbm93LCBhc3N1bWUgdGhlIHJlYXNvbiBmb3IgZmFpbHVyZSBpcyBhbHdheXMgYmVjYXVzZVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHRva2VucyBhcmUgZXhwaXJlZCBvciBtaXNzaW5nLCBzbyByYWlzZSB0aGF0IHRoZSBhY2NvdW50IGlzIHN0YWxlLlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcInN0YWxlXCIsIGFjY291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKDxhZGFsLlRva2VuUmVzcG9uc2U+cmVzcG9uc2UpLmFjY2Vzc1Rva2VuKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGxpc3RlbmVycyhldmVudDogXCJzdGFsZVwiKTogbWFuYWdlci5BY2NvdW50U3RhbGVMaXN0ZW5lcltdIHtcclxuICAgICAgICByZXR1cm4gPG1hbmFnZXIuQWNjb3VudFN0YWxlTGlzdGVuZXJbXT5zdXBlci5saXN0ZW5lcnMoZXZlbnQpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBQcm92aWRlckJhc2U7XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
