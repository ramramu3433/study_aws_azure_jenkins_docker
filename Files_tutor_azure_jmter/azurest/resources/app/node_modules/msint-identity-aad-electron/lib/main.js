/*!---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *----------------------------------------------------------*/
/// <reference path="../node_modules/@types/electron/index.d.ts" />
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var electron_1 = require("electron");
var q_1 = require("q");
var promptLoginParameter = "&prompt=login", authWindowsToClose = [];
function getAuthorizationCode(url, redirectUri, silent) {
    return q_1.Promise(function (resolve) {
        var capturedUrl = null, authWindow = new electron_1.BrowserWindow({
            show: !silent,
            width: 568,
            height: 720,
            resizable: false,
            center: true,
            webPreferences: {
                nodeIntegration: false
            }
        });
        authWindow.setMenuBarVisibility(false);
        var index = url.indexOf(promptLoginParameter);
        if (index > 0) {
            // The caller is requesting that a login prompt always be shown.
            // Unfortunately, this is buggy in AAD and they sometimes ask
            // for the password twice. The alternative way to force the prompt
            // to be shown is to clear the browser cookie cache. So, remove
            // the detected query option from the URL and clear the cache.
            url = url.substr(0, index) + url.substr(index + "&prompt=login".length);
            authWindow.webContents.session.clearStorageData({ storages: ["cookies"] }, browseToUrl);
        }
        else {
            browseToUrl();
        }
        function browseToUrl() {
            authWindow.loadURL(url);
            // After loading the initial URL, we need to let the browser run
            // until it encounters the redirect URI. When this happens, the
            // browser window should be automatically closed.
            // There are a number of possible events that seem like they would
            // work for this, but the only one that actually works is the
            // did-get-redirect-request event, which is called before the
            // browser responds to a redirect request.
            authWindow.webContents.on("did-get-redirect-request", onDidGetRedirectRequest);
            authWindow.on("close", onClose);
            function onDidGetRedirectRequest(event, oldUrl, newUrl) {
                if (newUrl.indexOf(redirectUri + "?") === 0) {
                    capturedUrl = newUrl;
                    if (newUrl.toLowerCase().indexOf("urn:") === 0) {
                        // The redirect URI is using the custom "urn" scheme
                        // for which a protocol handler was registered. In this
                        // case, we CANNOT immediately close the auth window,
                        // because Electron then has a race-condition between
                        // closure of the window and calling of the custom
                        // protocol handler that had to be registered to stop
                        // prompting to open a "urn". If the window gets closed
                        // before the protocol handler is called, then Electron
                        // crashes because it is unable to pass the deallocated
                        // window to the handler. The observed behavior of
                        // Electron is that the did-get-redirect-request event
                        // is always raised before the custom protocol handler
                        // is invoked, so we can schedule the window to be
                        // closed by the protocol handler instead.
                        authWindowsToClose.push(authWindow);
                    }
                    else {
                        authWindow.close();
                    }
                }
            }
            function onClose() {
                authWindow = null;
                resolve(capturedUrl);
            }
        }
    });
}
exports.getAuthorizationCode = getAuthorizationCode;
// Handle calls from renderer processes
electron_1.ipcMain.on("getAuthorizationCode", function (event, url, captureUrl, silent, token) {
    getAuthorizationCode(url, captureUrl, silent).then(function (capturedUrl) { return event.sender.send("getAuthorizationCode-reply", token, capturedUrl); });
});
// On Windows, handle requests to select a certificate through
// the selectcert module, which pops the native selection dialog.
if (process.platform === "win32") {
    electron_1.app.on("select-client-certificate", function (event, webContents, host, certificates, callback) {
        if (certificates.length <= 1) {
            // Default behavior is appropriate
            return false;
        }
        event.preventDefault();
        /* tslint:disable no-require-imports */
        var index = require("msint-selectcert").selectCertificate(certificates.map(function (c) { return c.data; }));
        /* tslint:enable */
        if (index >= 0) {
            callback(certificates[index]);
        }
        return true;
    });
}
// Register a custom protocol handler to deal with the "urn" scheme,
// which occurs in cases that the redirect URI is such a scheme.
// Otherwise the default behavior is to attempt a shell execute of
// the URI, which at least on Windows prompts the user to choose an
// application that handles "urn", which is not the desired behavior.
electron_1.app.on("ready", function () {
    electron_1.protocol.registerStringProtocol("urn", function (request, callback) {
        // Close all auth windows that need to be closed
        while (authWindowsToClose.length) {
            authWindowsToClose.shift().close();
        }
        // Doesn't matter how the protocol is handled; error is fine
        callback();
    });
});

//# sourceMappingURL=data:application/json;base64,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QyxDQUFDLENBQUM7UUFDekYsbUJBQW1CO1FBRW5CLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsUUFBUSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVELG9FQUFvRTtBQUNwRSxnRUFBZ0U7QUFDaEUsa0VBQWtFO0FBQ2xFLG1FQUFtRTtBQUNuRSxxRUFBcUU7QUFDckUsY0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUU7SUFDWixtQkFBUSxDQUFDLHNCQUFzQixDQUFDLEtBQUssRUFBRSxVQUFDLE9BQU8sRUFBRSxRQUFRO1FBQ3JELGdEQUFnRDtRQUNoRCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQy9CLGtCQUFrQixDQUFDLEtBQUssRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3ZDLENBQUM7UUFFRCw0REFBNEQ7UUFDNUQsUUFBUSxFQUFFLENBQUM7SUFDZixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiEtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogQ29weXJpZ2h0IChDKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXHJcblxyXG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vbm9kZV9tb2R1bGVzL0B0eXBlcy9lbGVjdHJvbi9pbmRleC5kLnRzXCIgLz5cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuaW1wb3J0IHsgYXBwLCBCcm93c2VyV2luZG93LCBpcGNNYWluIGFzIGlwYywgcHJvdG9jb2wgfSBmcm9tIFwiZWxlY3Ryb25cIjtcclxuaW1wb3J0IHsgUHJvbWlzZSB9IGZyb20gXCJxXCI7XHJcblxyXG5sZXQgcHJvbXB0TG9naW5QYXJhbWV0ZXIgPSBcIiZwcm9tcHQ9bG9naW5cIixcclxuICAgIGF1dGhXaW5kb3dzVG9DbG9zZTogRWxlY3Ryb24uQnJvd3NlcldpbmRvd1tdID0gW107XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXV0aG9yaXphdGlvbkNvZGUodXJsOiBzdHJpbmcsIHJlZGlyZWN0VXJpOiBzdHJpbmcsIHNpbGVudD86IGJvb2xlYW4pIHtcclxuICAgIHJldHVybiBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PiB7XHJcbiAgICAgICAgbGV0IGNhcHR1cmVkVXJsOiBzdHJpbmcgPSBudWxsLFxyXG4gICAgICAgICAgICBhdXRoV2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coe1xyXG4gICAgICAgICAgICAgICAgc2hvdzogIXNpbGVudCxcclxuICAgICAgICAgICAgICAgIHdpZHRoOiA1NjgsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IDcyMCxcclxuICAgICAgICAgICAgICAgIHJlc2l6YWJsZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBjZW50ZXI6IHRydWUsXHJcbiAgICAgICAgICAgICAgICB3ZWJQcmVmZXJlbmNlczoge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGVJbnRlZ3JhdGlvbjogZmFsc2VcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGF1dGhXaW5kb3cuc2V0TWVudUJhclZpc2liaWxpdHkoZmFsc2UpO1xyXG5cclxuICAgICAgICBsZXQgaW5kZXggPSB1cmwuaW5kZXhPZihwcm9tcHRMb2dpblBhcmFtZXRlcik7XHJcbiAgICAgICAgaWYgKGluZGV4ID4gMCkge1xyXG4gICAgICAgICAgICAvLyBUaGUgY2FsbGVyIGlzIHJlcXVlc3RpbmcgdGhhdCBhIGxvZ2luIHByb21wdCBhbHdheXMgYmUgc2hvd24uXHJcbiAgICAgICAgICAgIC8vIFVuZm9ydHVuYXRlbHksIHRoaXMgaXMgYnVnZ3kgaW4gQUFEIGFuZCB0aGV5IHNvbWV0aW1lcyBhc2tcclxuICAgICAgICAgICAgLy8gZm9yIHRoZSBwYXNzd29yZCB0d2ljZS4gVGhlIGFsdGVybmF0aXZlIHdheSB0byBmb3JjZSB0aGUgcHJvbXB0XHJcbiAgICAgICAgICAgIC8vIHRvIGJlIHNob3duIGlzIHRvIGNsZWFyIHRoZSBicm93c2VyIGNvb2tpZSBjYWNoZS4gU28sIHJlbW92ZVxyXG4gICAgICAgICAgICAvLyB0aGUgZGV0ZWN0ZWQgcXVlcnkgb3B0aW9uIGZyb20gdGhlIFVSTCBhbmQgY2xlYXIgdGhlIGNhY2hlLlxyXG4gICAgICAgICAgICB1cmwgPSB1cmwuc3Vic3RyKDAsIGluZGV4KSArIHVybC5zdWJzdHIoaW5kZXggKyBcIiZwcm9tcHQ9bG9naW5cIi5sZW5ndGgpO1xyXG4gICAgICAgICAgICBhdXRoV2luZG93LndlYkNvbnRlbnRzLnNlc3Npb24uY2xlYXJTdG9yYWdlRGF0YSh7IHN0b3JhZ2VzOiBbXCJjb29raWVzXCJdIH0sIGJyb3dzZVRvVXJsKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBicm93c2VUb1VybCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gYnJvd3NlVG9VcmwoKSB7XHJcbiAgICAgICAgICAgIGF1dGhXaW5kb3cubG9hZFVSTCh1cmwpO1xyXG5cclxuICAgICAgICAgICAgLy8gQWZ0ZXIgbG9hZGluZyB0aGUgaW5pdGlhbCBVUkwsIHdlIG5lZWQgdG8gbGV0IHRoZSBicm93c2VyIHJ1blxyXG4gICAgICAgICAgICAvLyB1bnRpbCBpdCBlbmNvdW50ZXJzIHRoZSByZWRpcmVjdCBVUkkuIFdoZW4gdGhpcyBoYXBwZW5zLCB0aGVcclxuICAgICAgICAgICAgLy8gYnJvd3NlciB3aW5kb3cgc2hvdWxkIGJlIGF1dG9tYXRpY2FsbHkgY2xvc2VkLlxyXG4gICAgICAgICAgICAvLyBUaGVyZSBhcmUgYSBudW1iZXIgb2YgcG9zc2libGUgZXZlbnRzIHRoYXQgc2VlbSBsaWtlIHRoZXkgd291bGRcclxuICAgICAgICAgICAgLy8gd29yayBmb3IgdGhpcywgYnV0IHRoZSBvbmx5IG9uZSB0aGF0IGFjdHVhbGx5IHdvcmtzIGlzIHRoZVxyXG4gICAgICAgICAgICAvLyBkaWQtZ2V0LXJlZGlyZWN0LXJlcXVlc3QgZXZlbnQsIHdoaWNoIGlzIGNhbGxlZCBiZWZvcmUgdGhlXHJcbiAgICAgICAgICAgIC8vIGJyb3dzZXIgcmVzcG9uZHMgdG8gYSByZWRpcmVjdCByZXF1ZXN0LlxyXG4gICAgICAgICAgICBhdXRoV2luZG93LndlYkNvbnRlbnRzLm9uKFwiZGlkLWdldC1yZWRpcmVjdC1yZXF1ZXN0XCIsIG9uRGlkR2V0UmVkaXJlY3RSZXF1ZXN0KTtcclxuICAgICAgICAgICAgYXV0aFdpbmRvdy5vbihcImNsb3NlXCIsIG9uQ2xvc2UpO1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBvbkRpZEdldFJlZGlyZWN0UmVxdWVzdChldmVudDogRXZlbnQsIG9sZFVybDogc3RyaW5nLCBuZXdVcmw6IHN0cmluZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5ld1VybC5pbmRleE9mKHJlZGlyZWN0VXJpICsgXCI/XCIpID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZWRVcmwgPSBuZXdVcmw7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1VybC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCJ1cm46XCIpID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSByZWRpcmVjdCBVUkkgaXMgdXNpbmcgdGhlIGN1c3RvbSBcInVyblwiIHNjaGVtZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3Igd2hpY2ggYSBwcm90b2NvbCBoYW5kbGVyIHdhcyByZWdpc3RlcmVkLiBJbiB0aGlzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhc2UsIHdlIENBTk5PVCBpbW1lZGlhdGVseSBjbG9zZSB0aGUgYXV0aCB3aW5kb3csXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgRWxlY3Ryb24gdGhlbiBoYXMgYSByYWNlLWNvbmRpdGlvbiBiZXR3ZWVuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNsb3N1cmUgb2YgdGhlIHdpbmRvdyBhbmQgY2FsbGluZyBvZiB0aGUgY3VzdG9tXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb3RvY29sIGhhbmRsZXIgdGhhdCBoYWQgdG8gYmUgcmVnaXN0ZXJlZCB0byBzdG9wXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByb21wdGluZyB0byBvcGVuIGEgXCJ1cm5cIi4gSWYgdGhlIHdpbmRvdyBnZXRzIGNsb3NlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWZvcmUgdGhlIHByb3RvY29sIGhhbmRsZXIgaXMgY2FsbGVkLCB0aGVuIEVsZWN0cm9uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyYXNoZXMgYmVjYXVzZSBpdCBpcyB1bmFibGUgdG8gcGFzcyB0aGUgZGVhbGxvY2F0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2luZG93IHRvIHRoZSBoYW5kbGVyLiBUaGUgb2JzZXJ2ZWQgYmVoYXZpb3Igb2ZcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRWxlY3Ryb24gaXMgdGhhdCB0aGUgZGlkLWdldC1yZWRpcmVjdC1yZXF1ZXN0IGV2ZW50XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlzIGFsd2F5cyByYWlzZWQgYmVmb3JlIHRoZSBjdXN0b20gcHJvdG9jb2wgaGFuZGxlclxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpcyBpbnZva2VkLCBzbyB3ZSBjYW4gc2NoZWR1bGUgdGhlIHdpbmRvdyB0byBiZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjbG9zZWQgYnkgdGhlIHByb3RvY29sIGhhbmRsZXIgaW5zdGVhZC5cclxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0aFdpbmRvd3NUb0Nsb3NlLnB1c2goYXV0aFdpbmRvdyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0aFdpbmRvdy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gb25DbG9zZSgpIHtcclxuICAgICAgICAgICAgICAgIGF1dGhXaW5kb3cgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShjYXB0dXJlZFVybCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuLy8gSGFuZGxlIGNhbGxzIGZyb20gcmVuZGVyZXIgcHJvY2Vzc2VzXHJcbmlwYy5vbihcImdldEF1dGhvcml6YXRpb25Db2RlXCIsIChcclxuICAgIGV2ZW50OiB7IHNlbmRlcjogRWxlY3Ryb24uV2ViQ29udGVudHMgfSxcclxuICAgIHVybDogc3RyaW5nLCBjYXB0dXJlVXJsOiBzdHJpbmcsIHNpbGVudDogYm9vbGVhbiwgdG9rZW46IG51bWJlcikgPT4ge1xyXG4gICAgZ2V0QXV0aG9yaXphdGlvbkNvZGUodXJsLCBjYXB0dXJlVXJsLCBzaWxlbnQpLnRoZW4oXHJcbiAgICAgICAgY2FwdHVyZWRVcmwgPT4gZXZlbnQuc2VuZGVyLnNlbmQoXCJnZXRBdXRob3JpemF0aW9uQ29kZS1yZXBseVwiLCB0b2tlbiwgY2FwdHVyZWRVcmwpKTtcclxufSk7XHJcblxyXG5pbnRlcmZhY2UgWDUwOUNlcnRpZmljYXRlIHtcclxuICAgIGlzc3Vlck5hbWU6IHN0cmluZztcclxuICAgIGRhdGE6IHN0cmluZztcclxufVxyXG5cclxuLy8gT24gV2luZG93cywgaGFuZGxlIHJlcXVlc3RzIHRvIHNlbGVjdCBhIGNlcnRpZmljYXRlIHRocm91Z2hcclxuLy8gdGhlIHNlbGVjdGNlcnQgbW9kdWxlLCB3aGljaCBwb3BzIHRoZSBuYXRpdmUgc2VsZWN0aW9uIGRpYWxvZy5cclxuaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09IFwid2luMzJcIikge1xyXG4gICAgYXBwLm9uKFwic2VsZWN0LWNsaWVudC1jZXJ0aWZpY2F0ZVwiLCAoXHJcbiAgICAgICAgZXZlbnQ6IEV2ZW50LCB3ZWJDb250ZW50czogRWxlY3Ryb24uV2ViQ29udGVudHMsXHJcbiAgICAgICAgaG9zdDogc3RyaW5nLCBjZXJ0aWZpY2F0ZXM6IFg1MDlDZXJ0aWZpY2F0ZVtdLFxyXG4gICAgICAgIGNhbGxiYWNrOiAoY2VydGlmaWNhdGU6IFg1MDlDZXJ0aWZpY2F0ZSkgPT4gdm9pZCkgPT4ge1xyXG4gICAgICAgIGlmIChjZXJ0aWZpY2F0ZXMubGVuZ3RoIDw9IDEpIHtcclxuICAgICAgICAgICAgLy8gRGVmYXVsdCBiZWhhdmlvciBpcyBhcHByb3ByaWF0ZVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLyogdHNsaW50OmRpc2FibGUgbm8tcmVxdWlyZS1pbXBvcnRzICovICAgICAgICBcclxuICAgICAgICBsZXQgaW5kZXggPSByZXF1aXJlKFwibXNpbnQtc2VsZWN0Y2VydFwiKS5zZWxlY3RDZXJ0aWZpY2F0ZShjZXJ0aWZpY2F0ZXMubWFwKGMgPT4gYy5kYXRhKSk7XHJcbiAgICAgICAgLyogdHNsaW50OmVuYWJsZSAqL1xyXG5cclxuICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhjZXJ0aWZpY2F0ZXNbaW5kZXhdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9KTtcclxufVxyXG5cclxuLy8gUmVnaXN0ZXIgYSBjdXN0b20gcHJvdG9jb2wgaGFuZGxlciB0byBkZWFsIHdpdGggdGhlIFwidXJuXCIgc2NoZW1lLFxyXG4vLyB3aGljaCBvY2N1cnMgaW4gY2FzZXMgdGhhdCB0aGUgcmVkaXJlY3QgVVJJIGlzIHN1Y2ggYSBzY2hlbWUuXHJcbi8vIE90aGVyd2lzZSB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyB0byBhdHRlbXB0IGEgc2hlbGwgZXhlY3V0ZSBvZlxyXG4vLyB0aGUgVVJJLCB3aGljaCBhdCBsZWFzdCBvbiBXaW5kb3dzIHByb21wdHMgdGhlIHVzZXIgdG8gY2hvb3NlIGFuXHJcbi8vIGFwcGxpY2F0aW9uIHRoYXQgaGFuZGxlcyBcInVyblwiLCB3aGljaCBpcyBub3QgdGhlIGRlc2lyZWQgYmVoYXZpb3IuXHJcbmFwcC5vbihcInJlYWR5XCIsICgpID0+IHtcclxuICAgIHByb3RvY29sLnJlZ2lzdGVyU3RyaW5nUHJvdG9jb2woXCJ1cm5cIiwgKHJlcXVlc3QsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgLy8gQ2xvc2UgYWxsIGF1dGggd2luZG93cyB0aGF0IG5lZWQgdG8gYmUgY2xvc2VkXHJcbiAgICAgICAgd2hpbGUgKGF1dGhXaW5kb3dzVG9DbG9zZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgYXV0aFdpbmRvd3NUb0Nsb3NlLnNoaWZ0KCkuY2xvc2UoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIERvZXNuJ3QgbWF0dGVyIGhvdyB0aGUgcHJvdG9jb2wgaXMgaGFuZGxlZDsgZXJyb3IgaXMgZmluZVxyXG4gICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICB9KTtcclxufSk7XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
